{% extends "base.html" %}

{% block title %}Notes - Notion Alternative{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('index') }}">Home</a>
<span class="breadcrumb-separator">/</span>
<span>Notes</span>
{% endblock %}

{% block top_bar_actions %}
<button class="btn btn-primary" onclick="showCreateModal('', 'file')">
    <i class="fas fa-plus"></i>
    New Note
</button>
<button class="btn btn-secondary" onclick="showCreateModal('', 'folder')">
    <i class="fas fa-folder-plus"></i>
    New Folder
</button>
{% endblock %}

{% block content %}
<div class="notes-page-container">
    <div class="notes-sidebar">
        <div class="notes-sidebar-header">
            <h4>Notes & Folders</h4>
        </div>
        <div class="notes-tree" id="noteTree">
            <!-- Notes tree will be loaded here by JS -->
            <div class="empty-state-small">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading notes...</p>
            </div>
        </div>
    </div>
    <div class="notes-main">
        <div id="noteEditor" class="note-editor-container" style="display: none;">
            <div class="note-editor-header">
                <h2 id="noteEditorTitle"></h2>
            </div>
            <!-- 
              FIX: The ID has been moved from the textarea to this parent div.
              This div will now act as the container for the rich text editor 
              or the fallback textarea, preventing invalid nested HTML.
            -->
            <div class="note-content-editor" id="noteEditor_editor">
                <!-- Editor will be dynamically inserted here by app.js -->
            </div>
        </div>
        <div id="notesEmptyState" class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-clipboard"></i>
            </div>
            <h3>Select a note or create a new one</h3>
            <p>Your notes will appear here. Organize them into folders for easy access.</p>
            <button class="btn btn-primary" onclick="showCreateModal('', 'file')">
                <i class="fas fa-plus"></i>
                Create New Note
            </button>
        </div>
    </div>
</div>

<!-- Share Modal (hidden, shown by JS) -->
<div class="modal-overlay" id="shareNoteModalOverlay" style="display:none;">
    <div class="modal" style="max-width: 420px;">
        <div class="modal-header">
            <h3>Share Note</h3>
            <button class="close-modal" onclick="closeShareNoteModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-content" id="shareNoteModalContent">
            <!-- Content loaded by JS -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Add RichTextEditor library BEFORE app.js -->
<!-- Option 1: If using Quill.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.snow.css" rel="stylesheet">

<!-- Option 2: If using TinyMCE -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js"></script> -->

<!-- Option 3: If using CKEditor -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/ckeditor/4.22.1/ckeditor.js"></script> -->

<!-- Option 4: If you have a custom RichTextEditor -->
<!-- <script src="{{ url_for('static', filename='js/rich-text-editor.js') }}"></script> -->

<script>
    // Create a simple RichTextEditor wrapper for Quill
    if (typeof Quill !== 'undefined') {
        window.RichTextEditor = function(selector, options) {
            options = options || {};
            const element = typeof selector === 'string' ? document.querySelector(selector) : selector;
            
            if (!element) {
                console.error('RichTextEditor: Element not found');
                return null;
            }

            // Clear the element and create Quill
            element.innerHTML = '';
            
            const quill = new Quill(element, {
                theme: 'snow',
                placeholder: options.placeholder || 'Start typing...',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        ['blockquote', 'code-block'],
                        [{ 'header': 1 }, { 'header': 2 }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        ['link', 'image'],
                        ['clean']
                    ]
                }
            });

            // Set height if specified
            if (options.height) {
                element.style.height = options.height;
                const editor = element.querySelector('.ql-editor');
                if (editor) {
                    editor.style.height = 'calc(' + options.height + ' - 42px)'; // Subtract toolbar height
                }
            }

            // Store change callback for later use
            let changeCallback = null;

            // Return wrapper with standard methods
            const wrapper = {
                setContent: function(content) {
                    // Disable change events temporarily to avoid triggering auto-save during load
                    const tempCallback = changeCallback;
                    changeCallback = null;
                    
                    quill.root.innerHTML = content;
                    
                    // Re-enable change events after a short delay
                    setTimeout(() => {
                        changeCallback = tempCallback;
                    }, 100);
                },
                getContent: function() {
                    return quill.root.innerHTML;
                },
                setHTML: function(content) {
                    return this.setContent(content);
                },
                getHTML: function() {
                    return this.getContent();
                },
                setValue: function(content) {
                    return this.setContent(content);
                },
                getValue: function() {
                    return this.getContent();
                },
                html: function(content) {
                    if (content !== undefined) {
                        return this.setContent(content);
                    }
                    return this.getContent();
                },
                on: function(event, callback) {
                    if (event === 'text-change' || event === 'change' || event === 'input') {
                        changeCallback = callback;
                        quill.on('text-change', function() {
                            if (changeCallback) {
                                changeCallback();
                            }
                        });
                    }
                },
                onChange: function(callback) {
                    changeCallback = callback;
                    quill.on('text-change', function() {
                        if (changeCallback) {
                            changeCallback();
                        }
                    });
                },
                destroy: function() {
                    changeCallback = null;
                    // Quill doesn't have a destroy method, so we clear the container
                    element.innerHTML = '';
                }
            };

            // Set up auto-save immediately if not disabled
            if (options.autoSave !== false) {
                let saveTimeout;
                const debouncedSave = () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        if (window.saveCurrentNote) {
                            console.log('Auto-saving note...');
                            window.saveCurrentNote();
                        }
                    }, 1000);
                };

                quill.on('text-change', function() {
                    if (changeCallback) {
                        changeCallback();
                    }
                    // Always trigger auto-save on text change
                    debouncedSave();
                });
            }

            return wrapper;
        };
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initial load of notes tree is handled by app.js
        // The empty state is shown by default and hidden when a note is opened.
        const notesEmptyState = document.getElementById('notesEmptyState');
        const noteEditor = document.getElementById('noteEditor');

        // Initially hide editor and show empty state
        noteEditor.style.display = 'none';
        notesEmptyState.style.display = 'flex'; // Use flex for centering
    });

    // This logic can be simplified now, but we'll keep it for consistency.
    // The visibility is primarily handled in openNote and deleteNoteOrFolder in app.js
    function showEditor() {
        document.getElementById('notesEmptyState').style.display = 'none';
        document.getElementById('noteEditor').style.display = 'block';
    }

    function showEmptyState() {
        document.getElementById('notesEmptyState').style.display = 'flex';
        document.getElementById('noteEditor').style.display = 'none';
    }

    // --- Share Note Modal Logic ---
    function showShareNoteModal(notePath) {
        // Show loading state
        const modal = document.getElementById('shareNoteModalOverlay');
        const content = document.getElementById('shareNoteModalContent');
        modal.style.display = 'flex';
        content.innerHTML = '<div style="text-align:center;padding:24px;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
        // Fetch or create share link
        fetch(`/api/notes/share/get?note_path=${encodeURIComponent(notePath)}`)
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    // Create new share
                    fetch('/api/notes/share/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ note_path: notePath, permission: 'view' })
                    })
                    .then(r2 => r2.json())
                    .then(data2 => renderShareModalContent(notePath, data2.share_id, data2.permission));
                } else {
                    renderShareModalContent(notePath, data.share_id, data.permission);
                }
            });
    }
    function renderShareModalContent(notePath, shareId, permission) {
        const publicUrl = '{{ config["APP_PUBLIC_URL"] if config and config["APP_PUBLIC_URL"] else "http://localhost:5000" }}';
        const link = `${publicUrl}/share/note/${shareId}`;
        const content = document.getElementById('shareNoteModalContent');
        content.innerHTML = `
            <div class="form-group">
                <label>Share Link</label>
                <div style="display:flex;gap:8px;align-items:center;">
                    <input type="text" id="shareNoteLinkInput" class="form-control" value="${link}" readonly style="flex:1;">
                    <button class="btn btn-secondary btn-sm" onclick="copyShareNoteLink()"><i class="fas fa-copy"></i></button>
                </div>
            </div>
            <div class="form-group">
                <label>Permission</label>
                <select id="shareNotePermission" class="form-control" onchange="updateShareNotePermission('${shareId}')">
                    <option value="view" ${permission==='view'?'selected':''}>View Only</option>
                    <option value="edit" ${permission==='edit'?'selected':''}>Editable</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeShareNoteModal()">Close</button>
                <a class="btn btn-primary" href="${link}" target="_blank"><i class="fas fa-external-link-alt"></i> Open Link</a>
            </div>
        `;
    }
    function closeShareNoteModal() {
        document.getElementById('shareNoteModalOverlay').style.display = 'none';
    }
    function copyShareNoteLink() {
        const input = document.getElementById('shareNoteLinkInput');
        input.select();
        document.execCommand('copy');
        input.blur();
    }
    function updateShareNotePermission(shareId) {
        const perm = document.getElementById('shareNotePermission').value;
        fetch('/api/notes/share/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ share_id: shareId, permission: perm })
        });
    }
</script>
{% endblock %}