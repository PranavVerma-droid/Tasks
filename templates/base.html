<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Task Manager{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="savingIndicator" class="saving-indicator">
        <i class="fas fa-cloud-upload-alt"></i> Saving...
    </div>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-cube"></i>
                    <span>NotionAlt</span>
                </div>
            </div>
            
            <div class="sidebar-content">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Quick Access</div>
                    <a href="{{ url_for('index') }}" class="sidebar-item">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                    <a href="{{ url_for('calendar_view') }}" class="sidebar-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Calendar</span>
                    </a>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Pages</div>
                    {% for page_id, page in data.pages.items() %}
                    {% if not page.parent_database_id %}
                    <div class="sidebar-page-item">
                        <a href="{{ url_for('view_page', page_id=page_id) }}" class="sidebar-item">
                            <i class="fas fa-file-alt"></i>
                            <span>{{ page.title }}</span>
                        </a>
                        {% if page.databases %}
                        <div class="sidebar-nested-databases">
                            {% for db_id in page.databases %}
                            {% if db_id in data.databases %}
                            {% set database = data.databases[db_id] %}
                            <div class="sidebar-database-item">
                                <div class="sidebar-database-header" onclick="toggleDatabaseTree(this)">
                                    <i class="fas fa-database"></i>
                                    <span>{{ database.name }}</span>
                                    <i class="fas fa-chevron-down expand-icon"></i>
                                </div>
                                {% if database.pages %}
                                <div class="sidebar-nested-pages">
                                    {% for nested_page_id in database.pages %}
                                    {% if nested_page_id in data.pages %}
                                    {% set nested_page = data.pages[nested_page_id] %}
                                    <a href="{{ url_for('navigate_to_page', page_id=nested_page_id) }}" class="sidebar-item sidebar-nested-item">
                                        <i class="fas fa-file-alt"></i>
                                        <span>{{ nested_page.title }}</span>
                                    </a>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <div class="breadcrumb">
                    {% block breadcrumb %}{% endblock %}
                </div>
                <div class="top-bar-actions">
                    {% block top_bar_actions %}{% endblock %}
                </div>
            </div>
            
            <div class="content-area">
                {% block content %}{% endblock %}
            </div>
        </div>

        <!-- Task Sidebar (for calendar view) -->
        <div class="task-sidebar" id="taskSidebar">
            <div class="task-sidebar-header">
                <h3 id="taskSidebarTitle">Task Details</h3>
                <button class="close-sidebar" onclick="closeTaskSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="task-sidebar-content" id="taskSidebarContent">
                <!-- Task details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Modal Title</h3>
                <button class="close-modal" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content" id="modalContent">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>
    
    <div id="autoSaveIndicator"></div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    {% block extra_js %}{% endblock %}
    
    <script>
    function toggleDatabaseTree(element) {
        const databaseItem = element.closest('.sidebar-database-item');
        const nestedPages = databaseItem.querySelector('.sidebar-nested-pages');
        const expandIcon = element.querySelector('.expand-icon');
        
        if (nestedPages) {
            databaseItem.classList.toggle('collapsed');
            
            if (databaseItem.classList.contains('collapsed')) {
                expandIcon.style.transform = 'rotate(-90deg)';
            } else {
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }
    }
    
    // Initialize collapsed state for databases with no pages
    document.addEventListener('DOMContentLoaded', function() {
        const databaseItems = document.querySelectorAll('.sidebar-database-item');
        databaseItems.forEach(item => {
            const nestedPages = item.querySelector('.sidebar-nested-pages');
            if (!nestedPages || nestedPages.children.length === 0) {
                item.classList.add('collapsed');
                const expandIcon = item.querySelector('.expand-icon');
                if (expandIcon) {
                    expandIcon.style.transform = 'rotate(-90deg)';
                }
            }
        });

        // Add auto-save listener for page title
        const pageTitleEl = document.getElementById('pageTitle');
        if (pageTitleEl) {
            pageTitleEl.addEventListener('input', () => {
                autoSaveContent('pageTitle', pageTitleEl.textContent);
            });
        }
    });

    // Auto-save functionality with debouncing
    const autoSaveTimers = {};
    
    function autoSaveContent(selector, content) {
        // Clear existing timer
        if (autoSaveTimers[selector]) {
            clearTimeout(autoSaveTimers[selector]);
        }
        
        // Show saving indicator
        showSavingIndicator(true);

        // Set new timer (save after 1.5 seconds of no typing)
        autoSaveTimers[selector] = setTimeout(() => {
            let savePromise;
            // Determine what type of content this is and save accordingly
            if (selector === 'pageTitle') {
                savePromise = autoSavePageTitle(content);
            } else if (selector.startsWith('pageDescriptionContainer')) {
                 const editorContent = getRichTextContent('#pageDescriptionContainer_editor');
                 savePromise = autoSavePageDescription(editorContent);
            }
            // Add other auto-save cases if needed

            if (savePromise) {
                savePromise.then(success => {
                    showSavingIndicator(false); // Hide saving indicator
                    showAutoSaveIndicator(success ? 'Saved' : 'Save failed', !success);
                });
            } else {
                showSavingIndicator(false); // Hide if no promise
            }
        }, 1500); // 1.5 second delay
    }

    function autoSavePageTitle(title) {
        if (!window.currentPageId) return Promise.resolve(false);
        
        return fetch('/api/update_page', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                page_id: window.currentPageId,
                updates: { title: title }
            })
        })
        .then(response => response.json())
        .then(data => data.success)
        .catch(() => false);
    }

    function autoSavePageDescription(content) {
        if (!window.currentPageId) return Promise.resolve(false);
        
        return fetch('/api/update_page', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                page_id: window.currentPageId,
                updates: {
                    properties: {
                        description: {
                            name: 'Description',
                            type: 'rich_text',
                            value: '',
                            rich_text_content: content
                        }
                    }
                }
            })
        })
        .then(response => response.json())
        .then(data => data.success)
        .catch(() => false);
    }

    function showSavingIndicator(show) {
        const indicator = document.getElementById('savingIndicator');
        if (indicator) {
            indicator.style.opacity = show ? '1' : '0';
        }
    }

    function showAutoSaveIndicator(message, isError = false) {
        // Create or update auto-save indicator
        let indicator = document.getElementById('autoSaveIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'autoSaveIndicator';
            document.body.appendChild(indicator);
        }
        
        indicator.textContent = message;
        indicator.className = isError ? 'error' : 'success';
        indicator.classList.add('show');
        
        // Hide after 3 seconds
        setTimeout(() => {
            indicator.classList.remove('show');
        }, 3000);
    }

    </script>
    <!-- Custom Rich Text Editor -->
    <style>
        .rich-editor-container {
            border: 1px solid #444;
            border-radius: 6px;
            background: #2a2a2a;
            overflow: hidden;
        }
        
        .rich-editor-toolbar {
            display: flex;
            gap: 2px;
            padding: 8px;
            background: #333;
            border-bottom: 1px solid #444;
            flex-wrap: wrap;
        }
        
        .rich-editor-btn {
            padding: 6px 10px;
            background: #444;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .rich-editor-btn:hover {
            background: #555;
        }
        
        .rich-editor-btn.active {
            background: #4a9eff;
        }
        
        .rich-editor-btn i {
            font-size: 14px;
        }
        
        .rich-editor-content {
            min-height: 200px;
            padding: 12px;
            outline: none;
            color: #fff;
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
        }
        
        .rich-editor-content:focus {
            background: #2a2a2a;
        }
        
        .rich-editor-content h1,
        .rich-editor-content h2,
        .rich-editor-content h3 {
            margin: 16px 0 8px 0;
            font-weight: 600;
        }
        
        .rich-editor-content h1 { font-size: 24px; }
        .rich-editor-content h2 { font-size: 20px; }
        .rich-editor-content h3 { font-size: 18px; }
        
        .rich-editor-content p {
            margin: 8px 0;
        }
        
        .rich-editor-content ul,
        .rich-editor-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .rich-editor-content blockquote {
            border-left: 4px solid #4a9eff;
            margin: 12px 0;
            padding-left: 12px;
            color: #ccc;
        }
        
        .rich-editor-content code {
            background: #333;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
        }
        
        .rich-editor-content pre {
            background: #333;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 12px 0;
        }
        
        .rich-editor-content pre code {
            background: none;
            padding: 0;
        }
    </style>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script>
        // Custom Rich Text Editor
        class RichTextEditor {
            constructor(selector, options = {}) {
                this.selector = selector;
                this.element = document.querySelector(selector);
                this.options = {
                    placeholder: options.placeholder || 'Enter description...',
                    height: options.height || 200,
                    autoSave: options.autoSave !== false,
                };
                
                this.init();
            }
            
            init() {
                if (!this.element) return;
                
                // Create editor container
                this.container = document.createElement('div');
                this.container.className = 'rich-editor-container';
                this.container.style.height = this.options.height + 'px';
                
                // Store reference to original element in container
                this.container.dataset.originalElementId = this.element.id;
                
                // Create toolbar
                this.toolbar = document.createElement('div');
                this.toolbar.className = 'rich-editor-toolbar';
                this.createToolbar();
                
                // Create content area
                this.content = document.createElement('div');
                this.content.className = 'rich-editor-content';
                this.content.contentEditable = true;
                this.content.innerHTML = this.element.value || '';
                this.content.setAttribute('data-placeholder', this.options.placeholder);
                
                // Replace original element
                this.element.parentNode.insertBefore(this.container, this.element);
                this.container.appendChild(this.toolbar);
                this.container.appendChild(this.content);
                this.element.style.display = 'none';
                
                // Add event listeners
                this.addEventListeners();
                
                // Set initial content
                if (this.element.value) {
                    this.setContent(this.element.value);
                }
            }
            
            createToolbar() {
                const tools = [
                    { name: 'bold', icon: 'fas fa-bold', title: 'Bold' },
                    { name: 'italic', icon: 'fas fa-italic', title: 'Italic' },
                    { name: 'underline', icon: 'fas fa-underline', title: 'Underline' },
                    { name: 'strikethrough', icon: 'fas fa-strikethrough', title: 'Strikethrough' },
                    { name: 'separator' },
                    { name: 'h1', icon: 'fas fa-heading', title: 'Heading 1' },
                    { name: 'h2', icon: 'fas fa-heading', title: 'Heading 2' },
                    { name: 'h3', icon: 'fas fa-heading', title: 'Heading 3' },
                    { name: 'separator' },
                    { name: 'ul', icon: 'fas fa-list-ul', title: 'Bullet List' },
                    { name: 'ol', icon: 'fas fa-list-ol', title: 'Numbered List' },
                    { name: 'blockquote', icon: 'fas fa-quote-left', title: 'Quote' },
                    { name: 'code', icon: 'fas fa-code', title: 'Code' },
                    { name: 'separator' },
                    { name: 'undo', icon: 'fas fa-undo', title: 'Undo' },
                    { name: 'redo', icon: 'fas fa-redo', title: 'Redo' },
                ];
                
                tools.forEach(tool => {
                    if (tool.name === 'separator') {
                        const separator = document.createElement('div');
                        separator.style.width = '1px';
                        separator.style.height = '20px';
                        separator.style.background = '#555';
                        separator.style.margin = '0 4px';
                        this.toolbar.appendChild(separator);
                    } else {
                        const btn = document.createElement('button');
                        btn.className = 'rich-editor-btn';
                        btn.title = tool.title;
                        btn.innerHTML = `<i class="${tool.icon}"></i>`;
                        btn.onclick = (e) => {
                            e.preventDefault();
                            this.execCommand(tool.name);
                        };
                        this.toolbar.appendChild(btn);
                    }
                });
            }
            
            execCommand(command) {
                this.content.focus();
                
                switch (command) {
                    case 'bold': document.execCommand('bold', false, null); break;
                    case 'italic': document.execCommand('italic', false, null); break;
                    case 'underline': document.execCommand('underline', false, null); break;
                    case 'strikethrough': document.execCommand('strikeThrough', false, null); break;
                    case 'h1': document.execCommand('formatBlock', false, 'h1'); break;
                    case 'h2': document.execCommand('formatBlock', false, 'h2'); break;
                    case 'h3': document.execCommand('formatBlock', false, 'h3'); break;
                    case 'ul': document.execCommand('insertUnorderedList', false, null); break;
                    case 'ol': document.execCommand('insertOrderedList', false, null); break;
                    case 'blockquote': document.execCommand('formatBlock', false, 'blockquote'); break;
                    case 'code':
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            const code = document.createElement('code');
                            code.textContent = range.toString();
                            range.deleteContents();
                            range.insertNode(code);
                        }
                        break;
                    case 'undo': document.execCommand('undo', false, null); break;
                    case 'redo': document.execCommand('redo', false, null); break;
                }
                
                this.updateToolbar();
                this.triggerChange();
            }
            
            updateToolbar() {
                const buttons = this.toolbar.querySelectorAll('.rich-editor-btn');
                buttons.forEach(btn => btn.classList.remove('active'));
                
                if (document.queryCommandState('bold')) this.toolbar.querySelector('[title="Bold"]').classList.add('active');
                if (document.queryCommandState('italic')) this.toolbar.querySelector('[title="Italic"]').classList.add('active');
                if (document.queryCommandState('underline')) this.toolbar.querySelector('[title="Underline"]').classList.add('active');
            }
            
            addEventListeners() {
                this.content.addEventListener('input', () => {
                    this.triggerChange();
                    this.autoSave();
                });
                
                this.content.addEventListener('keyup', () => this.updateToolbar());
                this.content.addEventListener('click', () => this.updateToolbar());
                this.content.addEventListener('focus', () => this.container.style.borderColor = '#4a9eff');
                this.content.addEventListener('blur', () => {
                    this.container.style.borderColor = '#444';
                    this.autoSave();
                });
                this.content.addEventListener('paste', () => setTimeout(() => {
                    this.triggerChange();
                    this.autoSave();
                }, 100));
            }
            
            triggerChange() {
                // This is a hook for potential future use
            }
            
            autoSave() {
                if (!this.options.autoSave) return;
                autoSaveContent(this.element.id, this.getContent());
            }
            
            getContent() {
                return this.content.innerHTML;
            }
            
            setContent(content) {
                this.content.innerHTML = content;
                this.element.value = content;
            }
            
            destroy() {
                if (this.container && this.container.parentNode) {
                    this.container.parentNode.removeChild(this.container);
                }
                this.element.style.display = '';
            }
        }

        // Initialize rich text editors
        document.addEventListener('DOMContentLoaded', function() {
            const richTextElements = document.querySelectorAll('textarea[data-rich-text="true"], .rich-text-editor');
            richTextElements.forEach(element => {
                new RichTextEditor(`#${element.id}`, {
                    placeholder: element.getAttribute('data-placeholder') || 'Enter description...',
                    height: parseInt(element.getAttribute('data-height')) || 200,
                    autoSave: true,
                });
            });
        });

        // Global functions for compatibility
        function getRichTextContent(selector) {
            const element = document.querySelector(selector);
            if (element) {
                const container = element.parentNode.querySelector('.rich-editor-container');
                if (container) {
                    const contentDiv = container.querySelector('.rich-editor-content');
                    if (contentDiv) return contentDiv.innerHTML;
                }
                return element.value || '';
            }
            return '';
        }

        function initRichTextEditorForModal() {
            const modal = document.querySelector('.modal-overlay.active');
            if (modal) {
                const richTextElements = modal.querySelectorAll('textarea[data-rich-text="true"], .rich-text-editor');
                richTextElements.forEach(element => {
                    if (!element.parentNode.querySelector('.rich-editor-container')) {
                        new RichTextEditor(`#${element.id}`, {
                            placeholder: element.getAttribute('data-placeholder') || 'Enter description...',
                            height: 200,
                            autoSave: false, // Disable auto-save for modal editors
                        });
                    }
                });
            }
        }
    </script>
</body>
</html>
