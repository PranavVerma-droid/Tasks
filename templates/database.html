{% extends "base.html" %}

{% block title %}{{ database.name }} - Notion Alternative{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('index') }}">Home</a>
{% for item in hierarchy %}
<span class="breadcrumb-separator">/</span>
{% if item.type == 'page' %}
<a href="{{ url_for('navigate_to_page', page_id=item.id) }}">{{ item.title }}</a>
{% else %}
<a href="{{ url_for('navigate_to_database', database_id=item.id) }}">{{ item.title }}</a>
{% endif %}
{% endfor %}
{% endblock %}

{% block top_bar_actions %}
<button class="btn btn-secondary" onclick="addPageToDatabase('{{ database.id }}')">
    <i class="fas fa-plus"></i>
    Add Page
</button>
<button class="btn btn-secondary" onclick="editDatabase('{{ database.id }}')">
    <i class="fas fa-cog"></i>
</button>
<button class="btn btn-primary" onclick="saveDatabase()">
    <i class="fas fa-save"></i>
    Save
</button>
{% endblock %}

{% block content %}
<div class="database-container">
    <div class="database-header">
        <h2 class="database-title">{{ database.name }}</h2>
    </div>
    {% set col_count = 2 + database.properties|length + 1 %}
    <div class="database-table">
        <div class="database-table-header" style="display: grid; grid-template-columns: 300px 200px{% for prop in database.properties %} 1fr{% endfor %} 100px;">
            <div class="table-cell table-cell-title">Title</div>
            <div class="table-cell">Description</div>
            {% for prop_id, prop in database.properties.items() %}
            <div class="table-cell">{{ prop.name }}</div>
            {% endfor %}
            <div class="table-cell table-cell-actions">Actions</div>
        </div>
        <div class="database-table-body">
            {% for page in pages %}
            <div class="database-table-row" style="display: grid; grid-template-columns: 300px 200px{% for prop in database.properties %} 1fr{% endfor %} 100px;" data-page-id="{{ page.id }}">
                <div class="table-cell table-cell-title">
                    <div class="page-title-container">
                        <div class="page-title-editable" contenteditable="true" onblur="updatePageTitle('{{ page.id }}', this.textContent)">
                            {{ page.title }}
                        </div>
                        {% if page.databases and page.databases|length > 0 %}
                        <i class="fas fa-folder-tree nested-indicator" title="Has nested databases"></i>
                        {% endif %}
                    </div>
                </div>
                <div class="table-cell">
                    {% if page.properties.description and (page.properties.description.rich_text_content or page.properties.description.value) %}
                        <div class="page-description">{{ page.properties.description.rich_text_content or page.properties.description.value }}</div>
                    {% else %}
                        <span class="empty-property">Empty</span>
                    {% endif %}
                </div>
                {% for prop_id, prop in database.properties.items() %}
                <div class="table-cell">
                    {% set pageProp = page.properties[prop_id] %}
                    {% if pageProp %}
                        {{ render_property_value(pageProp, prop) | safe }}
                    {% else %}
                        <span class="empty-property">-</span>
                    {% endif %}
                </div>
                {% endfor %}
                <div class="table-cell table-cell-actions">
                    <button class="btn btn-sm btn-secondary" onclick="editPage('{{ page.id }}')" title="Edit page">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-info" onclick="viewPageDetails('{{ page.id }}')" title="View details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="openPage('{{ page.id }}')" title="Open page">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deletePage('{{ page.id }}')" title="Delete page">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
const currentDatabaseId = '{{ database.id }}';

// Make currentDatabaseId globally accessible for auto-save
window.currentDatabaseId = currentDatabaseId;

// Load database data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadDatabaseData(currentDatabaseId);
});

function loadDatabaseData(databaseId) {
    fetch(`/api/get_database_data/${databaseId}`)
        .then(response => response.json())
        .then data => {
            if (data.success) {
                renderDatabaseTable(databaseId, data.pages, data.database);
            }
        })
        .catch(error => {
            console.error('Error loading database data:', error);
        });
}

function renderDatabaseTable(databaseId, pages, database) {
    const tableBody = document.getElementById(`databaseBody_${databaseId}`);
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    pages.forEach(page => {
        const row = document.createElement('div');
        row.className = 'database-table-row';
        row.setAttribute('data-page-id', page.id);
        
        // Title cell with description and nested databases indicator
        const titleCell = document.createElement('div');
        titleCell.className = 'table-cell table-cell-title';
        
        const description = page.properties.description ? page.properties.description.rich_text_content || page.properties.description.value : '';
        let descriptionHtml = '';
        
        if (description) {
            const isLongDescription = description.length > 50;
            const displayText = isLongDescription ? description.substring(0, 50) + '...' : description;
            const className = isLongDescription ? 'page-description has-full-text' : 'page-description';
            const dataAttr = isLongDescription ? `data-full-text="${description.replace(/"/g, '&quot;')}"` : '';
            
            descriptionHtml = `<div class="${className}" ${dataAttr}>${displayText}</div>`;
        }
        
        // Check if page has nested databases
        const hasNestedDatabases = page.databases && page.databases.length > 0;
        const nestedIndicator = hasNestedDatabases ? '<i class="fas fa-folder-tree nested-indicator" title="Has nested databases"></i>' : '';
        
        titleCell.innerHTML = `
            <div class="page-title-container">
                <div class="page-title-editable" contenteditable="true" onblur="updatePageTitle('${page.id}', this.textContent)">
                    ${page.title}
                </div>
                ${nestedIndicator}
            </div>
            ${descriptionHtml}
        `;
        
        // Make the entire row clickable to show details
        row.style.cursor = 'pointer';
        row.onclick = (e) => {
            // Don't trigger if clicking on action buttons
            if (!e.target.closest('.table-cell-actions')) {
                viewPageDetails(page.id);
            }
        };
        
        row.appendChild(titleCell);
        
        // Property cells
        Object.values(database.properties).forEach(prop => {
            const cell = document.createElement('div');
            cell.className = 'table-cell';
            
            const pageProp = page.properties[prop.id];
            if (pageProp) {
                cell.innerHTML = renderPropertyValue(pageProp, prop);
            } else {
                cell.innerHTML = '<span class="empty-property">-</span>';
            }
            
            row.appendChild(cell);
        });
        
        // Actions cell
        const actionsCell = document.createElement('div');
        actionsCell.className = 'table-cell table-cell-actions';
        actionsCell.innerHTML = `
            <button class="btn btn-sm btn-secondary" onclick="editPage('${page.id}')" title="Edit page">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-info" onclick="viewPageDetails('${page.id}')" title="View details">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-primary" onclick="openPage('${page.id}')" title="Open page">
                <i class="fas fa-external-link-alt"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deletePage('${page.id}')" title="Delete page">
                <i class="fas fa-trash"></i>
            </button>
        `;
        row.appendChild(actionsCell);
        
        tableBody.appendChild(row);
    });
}

function renderPropertyValue(pageProp, propDef) {
    switch (propDef.type) {
        case 'text':
            return `<span>${pageProp.value || ''}</span>`;
        case 'rich_text':
            const richContent = pageProp.rich_text_content || '';
            if (richContent) {
                return `<div class="rich-text-preview">${richContent}</div>`;
            }
            return `<span class="empty-property">-</span>`;
        case 'date':
            if (pageProp.value && typeof pageProp.value === 'object') {
                const dateValue = pageProp.value.start_date || pageProp.value.end_date || '';
                return `<span>${dateValue}</span>`;
            }
            return `<span>${pageProp.value || ''}</span>`;
        case 'select':
        case 'status':
            return `<span class="property-tag">${pageProp.value || ''}</span>`;
        case 'number':
            return `<span>${pageProp.value || ''}</span>`;
        default:
            return `<span>${pageProp.value || ''}</span>`;
    }
}

function addPageToDatabase(databaseId) {
    // Get database data to show all properties
    fetch(`/api/get_database_data/${databaseId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const database = data.database;
                showAddPageModal(databaseId, database);
            }
        })
        .catch(error => {
            console.error('Error loading database data:', error);
        });
}

function showAddPageModal(databaseId, database) {
    let propertiesHtml = '';
    let datePropIndex = null;
    let dateProp = null;
    // Find the date property (if any)
    Object.values(database.properties).forEach((prop, index) => {
        if (prop.type === 'date' && datePropIndex === null) {
            datePropIndex = index;
            dateProp = prop;
        }
    });
    // Build property inputs, skipping the date property (handled separately)
    Object.values(database.properties).forEach((prop, index) => {
        if (index === datePropIndex) return;
        propertiesHtml += `
            <div class=\"form-group\">
                <label for=\"modalProp_${index}\">${prop.name}</label>
                ${renderPropertyInput(prop, index)}
            </div>
        `;
    });
    // Date and repetition UI
    let dateRepetitionHtml = '';
    if (dateProp) {
        dateRepetitionHtml = `
            <div class=\"form-group\">
                <label for=\"modalDate\">${dateProp.name}</label>
                <input type=\"date\" id=\"modalDate\" class=\"form-control\">
                <div style=\"margin-top:8px;\">
                    <label><input type=\"checkbox\" id=\"repetitionCheckbox\" onchange=\"toggleRepetitionOptions()\"> Repetition</label>
                </div>
            </div>
            <div id=\"repetitionOptions\" style=\"display:none; margin-bottom: 12px;\">
                <div class=\"form-group\">
                    <label>Start Date</label>
                    <input type=\"date\" id=\"repetitionStartDate\" class=\"form-control\">
                </div>
                <div class=\"form-group\">
                    <label>End Date (Optional)</label>
                    <input type=\"date\" id=\"repetitionEndDate\" class=\"form-control\">
                </div>
                <div class=\"form-group\">
                    <label>Frequency</label>
                    <select id=\"repetitionType\" class=\"form-control\" onchange=\"updateRepetitionOptions()\">
                        <option value=\"daily\">Daily</option>
                        <option value=\"weekly\">Weekly</option>
                        <option value=\"monthly\">Monthly</option>
                        <option value=\"custom\">Custom</option>
                    </select>
                </div>
                <!-- Daily options -->
                <div class=\"form-group\" id=\"dailyOptions\" style=\"display:none\">
                    <label>Every</label>
                    <div style=\"display: flex; align-items: center; gap: 8px;\">
                        <input type=\"number\" id=\"dailyInterval\" class=\"form-control\" min=\"1\" value=\"1\" style=\"width: 80px;\">
                        <span>day(s)</span>
                    </div>
                </div>
                <!-- Weekly options -->
                <div id=\"weeklyOptions\" style=\"display:none\">
                    <div class=\"form-group\">
                        <label>Every</label>
                        <div style=\"display: flex; align-items: center; gap: 8px;\">
                            <input type=\"number\" id=\"weeklyInterval\" class=\"form-control\" min=\"1\" value=\"1\" style=\"width: 80px;\">
                            <span>week(s) on:</span>
                        </div>
                    </div>
                    <div class=\"form-group\">
                        <div id=\"weeklyDaysCheckboxes\" style=\"display: flex; flex-wrap: wrap; gap: 12px;\">
                            <label><input type=\"checkbox\" value=\"0\"> Sun</label>
                            <label><input type=\"checkbox\" value=\"1\"> Mon</label>
                            <label><input type=\"checkbox\" value=\"2\"> Tue</label>
                            <label><input type=\"checkbox\" value=\"3\"> Wed</label>
                            <label><input type=\"checkbox\" value=\"4\"> Thu</label>
                            <label><input type=\"checkbox\" value=\"5\"> Fri</label>
                            <label><input type=\"checkbox\" value=\"6\"> Sat</label>
                        </div>
                    </div>
                </div>
                <!-- Monthly options -->
                <div id=\"monthlyOptions\" style=\"display:none\">
                    <div class=\"form-group\">
                        <label>Every</label>
                        <div style=\"display: flex; align-items: center; gap: 8px;\">
                            <input type=\"number\" id=\"monthlyInterval\" class=\"form-control\" min=\"1\" value=\"1\" style=\"width: 80px;\">
                            <span>month(s) on day</span>
                            <input type=\"number\" id=\"monthlyDay\" class=\"form-control\" min=\"1\" max=\"31\" value=\"1\" style=\"width: 80px;\">
                        </div>
                    </div>
                </div>
                <!-- Custom options -->
                <div id=\"customOptions\" style=\"display:none\">
                    <div class=\"form-group\">
                        <label>Every</label>
                        <div style=\"display: flex; align-items: center; gap: 8px;\">
                            <input type=\"number\" id=\"customInterval\" class=\"form-control\" min=\"1\" value=\"2\" style=\"width: 80px;\">
                            <span>week(s) on:</span>
                        </div>
                    </div>
                    <div class=\"form-group\">
                        <div id=\"customDaysCheckboxes\" style=\"display: flex; flex-wrap: wrap; gap: 12px;\">
                            <label><input type=\"checkbox\" value=\"0\"> Sun</label>
                            <label><input type=\"checkbox\" value=\"1\"> Mon</label>
                            <label><input type=\"checkbox\" value=\"2\"> Tue</label>
                            <label><input type=\"checkbox\" value=\"3\"> Wed</label>
                            <label><input type=\"checkbox\" value=\"4\"> Thu</label>
                            <label><input type=\"checkbox\" value=\"5\"> Fri</label>
                            <label><input type=\"checkbox\" value=\"6\"> Sat</label>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    const modalContent = `
        <div class=\"form-group\">
            <label for=\"modalPageTitle\">Page Title</label>
            <input type=\"text\" id=\"modalPageTitle\" class=\"form-control\" placeholder=\"Enter page title\">
        </div>
        <div class=\"form-group\">
            <label for=\"modalPageDescription\">Description</label>
            <textarea id=\"modalPageDescription\" data-rich-text=\"true\" data-placeholder=\"Enter description...\"></textarea>
        </div>
        ${dateRepetitionHtml}
        ${propertiesHtml}
        <div class=\"modal-actions\">
            <button type=\"button\" class=\"btn btn-secondary\" onclick=\"closeModal()\">Cancel</button>
            <button type=\"button\" class=\"btn btn-primary\" onclick=\"confirmCreatePage('${databaseId}')\">Create Page</button>
        </div>
    `;
    document.getElementById('modalTitle').textContent = 'Add Page';
    document.getElementById('modalContent').innerHTML = modalContent;
    document.getElementById('modalOverlay').classList.add('active');
    setTimeout(() => {
        initRichTextEditorForModal();
        updateRepetitionOptions();
    }, 200);
}

function toggleRepetitionOptions() {
    const checkbox = document.getElementById('repetitionCheckbox');
    const options = document.getElementById('repetitionOptions');
    const singleDate = document.getElementById('singleDate');
    
    if (checkbox && checkbox.checked) {
        options.style.display = '';
        if (singleDate) singleDate.style.display = 'none';
        updateRepetitionOptions();
    } else {
        options.style.display = 'none';
        if (singleDate) singleDate.style.display = '';
    }
}

function updateRepetitionOptions() {
    const type = document.getElementById('repetitionType');
    if (!type) return;
    
    const typeValue = type.value;
    
    // Hide all option groups
    const optionGroups = ['dailyOptions', 'weeklyOptions', 'monthlyOptions', 'customOptions'];
    optionGroups.forEach(groupId => {
        const group = document.getElementById(groupId);
        if (group) group.style.display = 'none';
    });
    
    // Show relevant option group
    const targetGroup = document.getElementById(typeValue + 'Options');
    if (targetGroup) {
        targetGroup.style.display = '';
    }
}

function confirmCreatePage(databaseId) {
    const titleElement = document.getElementById('modalPageTitle');
    const descriptionElement = document.getElementById('modalPageDescription');
    
    if (!titleElement) {
        console.error('Page title element not found');
        return;
    }
    
    const title = titleElement.value;
    if (!title || !title.trim()) {
        alert('Please enter a page title');
        return;
    }
    
    // Get database to know what properties to collect
    fetch(`/api/get_database_data/${databaseId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const database = data.database;
                const properties = {};
                
                // Collect all property values
                Object.values(database.properties).forEach((prop, index) => {
                    const inputElement = document.getElementById(`modalProp_${index}`);
                    if (inputElement) {
                        let value = '';
                        if (prop.type === 'rich_text') {
                            value = getRichTextContent(`modalProp_${index}`);
                        } else if (prop.type === 'date') {
                            // Handle date/repetition logic
                            const repetitionChecked = document.getElementById('repetitionCheckbox') && document.getElementById('repetitionCheckbox').checked;
                            
                            if (!repetitionChecked) {
                                // Single date
                                value = document.getElementById('singleDate').value;
                            } else {
                                // Repetition
                                const repetitionType = document.getElementById('repetitionType').value;
                                const startDate = document.getElementById('repetitionStartDate').value;
                                const endDate = document.getElementById('repetitionEndDate').value;
                                
                                if (!startDate) {
                                    alert('Please select a start date for repetition');
                                    return;
                                }
                                
                                const repetitionConfig = {
                                    start_date: startDate,
                                    repetition: true,
                                    repetition_type: repetitionType,
                                    repetition_config: {
                                        end_date: endDate || null
                                    }
                                };
                                
                                // Add type-specific configuration
                                if (repetitionType === 'daily') {
                                    const interval = parseInt(document.getElementById('dailyInterval').value) || 1;
                                    repetitionConfig.repetition_config.interval = interval;
                                } else if (repetitionType === 'weekly') {
                                    const interval = parseInt(document.getElementById('weeklyInterval').value) || 1;
                                    const daysChecked = Array.from(document.querySelectorAll('#weeklyDaysCheckboxes input[type=checkbox]:checked'))
                                        .map(cb => parseInt(cb.value));
                                    
                                    if (daysChecked.length === 0) {
                                        alert('Please select at least one day of the week');
                                        return;
                                    }
                                    
                                    repetitionConfig.repetition_config.interval = interval;
                                    repetitionConfig.repetition_config.days_of_week = daysChecked;
                                } else if (repetitionType === 'monthly') {
                                    const interval = parseInt(document.getElementById('monthlyInterval').value) || 1;
                                    const dayOfMonth = parseInt(document.getElementById('monthlyDay').value) || 1;
                                    
                                    repetitionConfig.repetition_config.interval = interval;
                                    repetitionConfig.repetition_config.day_of_month = dayOfMonth;
                                } else if (repetitionType === 'custom') {
                                    const interval = parseInt(document.getElementById('customInterval').value) || 2;
                                    const daysChecked = Array.from(document.querySelectorAll('#customDaysCheckboxes input[type=checkbox]:checked'))
                                        .map(cb => parseInt(cb.value));
                                    
                                    if (daysChecked.length === 0) {
                                        alert('Please select at least one day for custom repetition');
                                        return;
                                    }
                                    
                                    repetitionConfig.repetition_config.interval = interval;
                                    repetitionConfig.repetition_config.days_of_week = daysChecked;
                                }
                                
                                value = repetitionConfig;
                            }
                        } else {
                            value = inputElement.value;
                        }
                        
                        if (value) {
                            properties[prop.id] = {
                                name: prop.name,
                                type: prop.type,
                                value: prop.type === 'rich_text' ? '' : value,
                                rich_text_content: prop.type === 'rich_text' ? value : null
                            };
                        }
                    }
                });
                
                // Add description property
                if (descriptionElement) {
                    setTimeout(() => {
                        const descriptionContent = getRichTextContent('modalPageDescription');
                        console.log('Description content retrieved:', descriptionContent);
                        if (descriptionContent && descriptionContent.trim()) {
                            properties['description'] = {
                                name: 'Description',
                                type: 'rich_text',
                                value: '',
                                rich_text_content: descriptionContent.trim()
                            };
                            console.log('Description property added:', properties['description']);
                        }
                        
                        console.log('Final properties object:', properties);
                        createPageWithProperties(databaseId, title, properties);
                    }, 100);
                } else {
                    console.log('Final properties object:', properties);
                    createPageWithProperties(databaseId, title, properties);
                }
            }
        })
        .catch(error => {
            console.error('Error getting database data:', error);
        });
    
    closeModal();
}

function createPageWithProperties(databaseId, title, properties) {
    fetch('/api/create_page', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            database_id: databaseId,
            title: title,
            properties: properties
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadDatabaseData(databaseId);
        } else {
            alert('Error creating page: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error creating page:', error);
        alert('Error creating page');
    });
}

function updatePageTitle(pageId, newTitle) {
    fetch('/api/update_page', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            page_id: pageId,
            updates: {
                title: newTitle
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Page title updated');
        }
    })
    .catch(error => {
        console.error('Error updating page title:', error);
    });
}

function openPage(pageId) {
    // Navigate to the page
    window.location.href = `/api/navigate_to_page/${pageId}`;
}

function viewPageDetails(pageId) {
    fetch(`/api/get_page_data/${pageId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const page = data.page;
                showPageDetailsModal(page);
            }
        })
        .catch(error => {
            console.error('Error loading page data:', error);
        });
}

function showPageDetailsModal(page) {
    let propertiesHtml = '';
    
    // Separate description from other properties
    Object.values(page.properties).forEach(prop => {
        if (prop.name === 'Description') {
            return; // Skip description here, we'll show it separately
        }
        if (prop.value) {
            propertiesHtml += `
                <div class="detail-property">
                    <label>${prop.name}:</label>
                    <div class="detail-value">${prop.value}</div>
                </div>
            `;
        }
    });
    
    const description = page.properties.description ? page.properties.description.value : '';
    const descriptionHtml = description ? `
        <div class="page-description-section">
            <h4>Description</h4>
            <div class="page-description-full">${description}</div>
        </div>
    ` : '';
    
    const modalContent = `
        <div class="page-details">
            <div class="page-header">
                <h3>${page.title}</h3>
                <div class="page-meta">
                    <span class="page-id">ID: ${page.id}</span>
                    <span class="page-date">Created: ${page.created_at ? new Date(page.created_at).toLocaleDateString() : 'Unknown'}</span>
                </div>
            </div>
            ${descriptionHtml}
            ${propertiesHtml ? `
                <div class="page-properties-section">
                    <h4>Properties</h4>
                    <div class="page-properties">
                        ${propertiesHtml}
                    </div>
                </div>
            ` : ''}
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button type="button" class="btn btn-primary" onclick="openPage('${page.id}')">Open Page</button>
        </div>
    `;
    
    document.getElementById('modalTitle').textContent = 'Task Details';
    document.getElementById('modalContent').innerHTML = modalContent;
    document.getElementById('modalOverlay').classList.add('active');
}

function editPage(pageId) {
    // Load page data and show edit modal
    fetch(`/api/get_page_data/${pageId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const page = data.page;
                showPageEditModal(page);
            }
        })
        .catch(error => {
            console.error('Error loading page data:', error);
        });
}

function showPageEditModal(page) {
    let propertiesHtml = '';
    Object.values(page.properties).forEach((prop, idx) => {
        if (prop.name === 'Description') {
            return;
        }
        if (prop.type === 'date') {
            let value = prop.value;
            let isRepeating = value && typeof value === 'object' && value.repetition;
            let dateValue = '';
            let rep = value || {};
            let config = rep.repetition_config || {};
            if (!isRepeating) {
                dateValue = typeof value === 'object' ? (value.start_date || '') : (value || '');
            }
            propertiesHtml += `
                <div class="form-group" data-property-id="${prop.id || 'prop_' + idx}" data-property-type="date">
                    <label for="editProp_${idx}">${prop.name}</label>
                    <input type="date" id="editProp_${idx}" class="form-control" value="${dateValue}" style="${isRepeating ? 'display:none;' : ''}">
                    <div style="margin-top:8px;">
                        <label><input type="checkbox" id="editRepetitionCheckbox_${idx}" onchange="toggleEditRepetitionOptions(${idx})" ${isRepeating ? 'checked' : ''}> Repetition</label>
                    </div>
                    <div id="editRepetitionOptions_${idx}" style="display:${isRepeating ? '' : 'none'}; margin-bottom: 12px;">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="editRepetitionStartDate_${idx}" class="form-control" value="${rep.start_date || ''}">
                        </div>
                        <div class="form-group">
                            <label>End Date (Optional)</label>
                            <input type="date" id="editRepetitionEndDate_${idx}" class="form-control" value="${config.end_date || ''}">
                        </div>
                        <div class="form-group">
                            <label>Frequency</label>
                            <select id="editRepetitionType_${idx}" class="form-control" onchange="updateEditRepetitionOptions(${idx})">
                                <option value="daily" ${rep.repetition_type === 'daily' ? 'selected' : ''}>Daily</option>
                                <option value="weekly" ${rep.repetition_type === 'weekly' ? 'selected' : ''}>Weekly</option>
                                <option value="monthly" ${rep.repetition_type === 'monthly' ? 'selected' : ''}>Monthly</option>
                                <option value="custom" ${rep.repetition_type === 'custom' ? 'selected' : ''}>Custom</option>
                            </select>
                        </div>
                        <div class="form-group" id="editDailyOptions_${idx}" style="display:${rep.repetition_type === 'daily' ? '' : 'none'}">
                            <label>Every</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="number" id="editDailyInterval_${idx}" class="form-control" min="1" value="${config.interval || 1}" style="width: 80px;">
                                <span>day(s)</span>
                            </div>
                        </div>
                        <div id="editWeeklyOptions_${idx}" style="display:${rep.repetition_type === 'weekly' ? '' : 'none'}">
                            <div class="form-group">
                                <label>Every</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="editWeeklyInterval_${idx}" class="form-control" min="1" value="${config.interval || 1}" style="width: 80px;">
                                    <span>week(s) on:</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <div id="editWeeklyDaysCheckboxes_${idx}" style="display: flex; flex-wrap: wrap; gap: 12px;">
                                    ${[0,1,2,3,4,5,6].map(d => `<label><input type="checkbox" value="${d}" ${config.days_of_week && config.days_of_week.includes(d) ? 'checked' : ''}> ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d]}</label>`).join('')}
                                </div>
                            </div>
                        </div>
                        <div id="editMonthlyOptions_${idx}" style="display:${rep.repetition_type === 'monthly' ? '' : 'none'}">
                            <div class="form-group">
                                <label>Every</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="editMonthlyInterval_${idx}" class="form-control" min="1" value="${config.interval || 1}" style="width: 80px;">
                                    <span>month(s) on day</span>
                                    <input type="number" id="editMonthlyDay_${idx}" class="form-control" min="1" max="31" value="${config.day_of_month || 1}" style="width: 80px;">
                                </div>
                            </div>
                        </div>
                        <div id="editCustomOptions_${idx}" style="display:${rep.repetition_type === 'custom' ? '' : 'none'}">
                            <div class="form-group">
                                <label>Every</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="editCustomInterval_${idx}" class="form-control" min="1" value="${config.interval || 2}" style="width: 80px;">
                                    <span>week(s) on:</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <div id="editCustomDaysCheckboxes_${idx}" style="display: flex; flex-wrap: wrap; gap: 12px;">
                                    ${[0,1,2,3,4,5,6].map(d => `<label><input type="checkbox" value="${d}" ${config.days_of_week && config.days_of_week.includes(d) ? 'checked' : ''}> ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d]}</label>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else if (prop.type === 'rich_text') {
            propertiesHtml += `
                <div class="form-group" data-property-id="${prop.id || 'prop_' + idx}" data-property-type="${prop.type}">
                    <label for="editProp_${idx}">${prop.name}</label>
                    <textarea id="editProp_${idx}" data-rich-text="true" data-placeholder="Edit ${prop.name.toLowerCase()}...">${prop.rich_text_content || prop.value || ''}</textarea>
                </div>
            `;
        } else {
            propertiesHtml += `
                <div class="form-group" data-property-id="${prop.id || 'prop_' + idx}" data-property-type="${prop.type}">
                    <label for="editProp_${idx}">${prop.name}</label>
                    <input type="text" id="editProp_${idx}" class="form-control" value="${prop.value || ''}" placeholder="Edit ${prop.name.toLowerCase()}...">
                </div>
            `;
        }
    });
    const modalContent = `
        <div class="form-group">
            <label for="editPageTitle">Page Title</label>
            <input type="text" id="editPageTitle" class="form-control" value="${page.title}">
        </div>
        ${propertiesHtml}
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="confirmEditPage('${page.id}')">Save Changes</button>
        </div>
    `;
    document.getElementById('modalTitle').textContent = 'Edit Page';
    document.getElementById('modalContent').innerHTML = modalContent;
    document.getElementById('modalOverlay').classList.add('active');
    setTimeout(() => {
        const richTextFields = document.querySelectorAll('textarea[data-rich-text="true"]');
        richTextFields.forEach(el => {
            initRichTextEditor('#' + el.id, el.getAttribute('data-placeholder') || 'Edit...');
        });
    }, 300);
}

function toggleEditRepetitionOptions(idx) {
    const checkbox = document.getElementById(`editRepetitionCheckbox_${idx}`);
    const options = document.getElementById(`editRepetitionOptions_${idx}`);
    const singleDate = document.getElementById(`editProp_${idx}`);
    if (checkbox && checkbox.checked) {
        options.style.display = '';
        if (singleDate) singleDate.style.display = 'none';
        updateEditRepetitionOptions(idx);
    } else {
        options.style.display = 'none';
        if (singleDate) singleDate.style.display = '';
    }
}

function updateEditRepetitionOptions(idx) {
    const type = document.getElementById(`editRepetitionType_${idx}`).value;
    const optionGroups = ['Daily', 'Weekly', 'Monthly', 'Custom'];
    optionGroups.forEach(group => {
        const groupDiv = document.getElementById(`edit${group}Options_${idx}`);
        if (groupDiv) groupDiv.style.display = 'none';
    });
    const targetGroup = document.getElementById(`edit${type.charAt(0).toUpperCase() + type.slice(1)}Options_${idx}`);
    if (targetGroup) targetGroup.style.display = '';
}

function confirmEditPage(pageId) {
    const newTitle = document.getElementById('editPageTitle').value;
    const modal = document.getElementById('modalContent');
    const formGroups = modal.querySelectorAll('.form-group[data-property-id]');
    const updates = { title: newTitle, properties: {} };
    
    formGroups.forEach((group) => {
        const propertyId = group.getAttribute('data-property-id');
        const propertyType = group.getAttribute('data-property-type');
        const label = group.querySelector('label');
        const propertyName = label ? label.textContent.replace(':', '').trim() : propertyId;
        
        if (propertyType === 'rich_text') {
            const textarea = group.querySelector('textarea[data-rich-text="true"]');
            if (textarea) {
                console.log('Processing rich text field:', textarea.id);
                let value = getRichTextContent(textarea.id);
                console.log('Rich text content retrieved:', value);
                
                // Clean up placeholder content
                if (value === `<p>Edit ${propertyName.toLowerCase()}...</p>` || value === '<p></p>') {
                    value = '';
                }
                
                updates.properties[propertyId] = {
                    name: propertyName,
                    type: 'rich_text',
                    value: '',
                    rich_text_content: value
                };
            }
        } else {
            const input = group.querySelector('input.form-control');
            if (input) {
                updates.properties[propertyId] = {
                    name: propertyName,
                    type: propertyType,
                    value: input.value
                };
            }
        }
    });
    
    console.log('Updates being sent:', updates);
    
    fetch('/api/update_page', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            page_id: pageId,
            updates: updates
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal();
            location.reload();
        } else {
            console.error('Update failed:', data);
            alert('Failed to update page: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error updating page:', error);
        alert('Error updating page');
    });
}

function deletePage(pageId) {
    if (confirm('Are you sure you want to delete this page? This action cannot be undone.')) {
        fetch('/api/delete_page', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                page_id: pageId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the row from the UI
                const row = document.querySelector(`[data-page-id="${pageId}"]`);
                if (row) {
                    row.remove();
                }
                // Or reload the page to refresh the data
                location.reload();
            } else {
                alert('Error deleting page: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting page:', error);
            alert('Error deleting page');
        });
    }
}

function editDatabase(databaseId) {
    // Load database data and show edit modal
    fetch(`/api/get_database_data/${databaseId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const database = data.database;
                showDatabaseEditModal(database);
            }
        })
        .catch(error => {
            console.error('Error loading database data:', error);
        });
}

function showDatabaseEditModal(database) {
    let propertiesHtml = '';
    
    Object.values(database.properties).forEach((prop, index) => {
        propertiesHtml += `
            <div class="property-item" data-property-id="${prop.id}">
                <input type="text" class="form-control property-name" value="${prop.name}" placeholder="Property name">
                <select class="form-control property-type">
                    <option value="text" ${prop.type === 'text' ? 'selected' : ''}>Text</option>
                    <option value="rich_text" ${prop.type === 'rich_text' ? 'selected' : ''}>Rich Text</option>
                    <option value="date" ${prop.type === 'date' ? 'selected' : ''}>Date</option>
                    <option value="select" ${prop.type === 'select' ? 'selected' : ''}>Select</option>
                    <option value="status" ${prop.type === 'status' ? 'selected' : ''}>Status</option>
                    <option value="number" ${prop.type === 'number' ? 'selected' : ''}>Number</option>
                </select>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeProperty(this)">Remove</button>
            </div>
        `;
    });
    
    const modalContent = `
        <div class="form-group">
            <label for="editDatabaseName">Database Name</label>
            <input type="text" id="editDatabaseName" class="form-control" value="${database.name}">
        </div>
        <div class="form-group">
            <label>Properties</label>
            <div id="editPropertiesList">
                ${propertiesHtml}
            </div>
            <button type="button" class="btn btn-sm btn-secondary" onclick="addPropertyToEdit()">Add Property</button>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-danger" onclick="deleteDatabase('${database.id}')">Delete Database</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="confirmUpdateDatabase('${database.id}')">Update Database</button>
        </div>
    `;
    
    document.getElementById('modalTitle').textContent = 'Edit Database';
    document.getElementById('modalContent').innerHTML = modalContent;
    document.getElementById('modalOverlay').classList.add('active');
}

function addPropertyToEdit() {
    const propertiesList = document.getElementById('editPropertiesList');
    if (!propertiesList) {
        console.error('Edit properties list not found');
        return;
    }
    
    const propertyItem = document.createElement('div');
    propertyItem.className = 'property-item';
    propertyItem.innerHTML = `
        <input type="text" class="form-control property-name" placeholder="Property name">
                            <select class="form-control property-type">
                        <option value="text">Text</option>
                        <option value="rich_text">Rich Text</option>
                        <option value="date">Date</option>
                        <option value="select">Select</option>
                        <option value="status">Status</option>
                        <option value="number">Number</option>
                    </select>
        <button type="button" class="btn btn-sm btn-danger" onclick="removeProperty(this)">Remove</button>
    `;
    propertiesList.appendChild(propertyItem);
}

function confirmUpdateDatabase(databaseId) {
    const nameElement = document.getElementById('editDatabaseName');
    if (!nameElement) {
        console.error('Database name element not found');
        return;
    }
    
    const name = nameElement.value;
    if (!name || !name.trim()) {
        alert('Please enter a database name');
        return;
    }
    
    const properties = {};
    document.querySelectorAll('#editPropertiesList .property-item').forEach((item, index) => {
        const propName = item.querySelector('.property-name').value;
        const propType = item.querySelector('.property-type').value;
        
        if (propName) {
            const propId = item.dataset.propertyId || `prop_${index}`;
            properties[propId] = {
                name: propName,
                type: propType,
                options: propType === 'select' || propType === 'status' ? ['Not Started', 'In Progress', 'Done'] : []
            };
        }
    });
    
    updateDatabase(databaseId, name, properties);
    closeModal();
}

function updateDatabase(databaseId, name, properties) {
    fetch('/api/update_database', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            database_id: databaseId,
            name: name,
            properties: properties
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating database: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error updating database:', error);
        alert('Error updating database');
    });
}

function deleteDatabase(databaseId) {
    if (confirm('Are you sure you want to delete this database? This action cannot be undone.')) {
        fetch('/api/delete_database', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                database_id: databaseId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting database: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting database:', error);
            alert('Error deleting database');
        });
    }
}

function saveDatabase() {
    // This would save any changes to the database
    console.log('Saving database...');
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
}
</script>
{% endblock %}