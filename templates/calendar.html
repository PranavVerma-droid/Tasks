{% extends "base.html" %}

{% block title %}Calendar - Task Manager{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('index') }}">Home</a>
<span class="breadcrumb-separator">/</span>
<span>Calendar</span>
{% endblock %}

{% block top_bar_actions %}
<div class="calendar-nav">
    <button class="btn btn-primary" onclick="goToToday()">Today</button>
    <div class="nav-arrows">
        <button class="btn btn-secondary" onclick="navigate('prev')">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button class="btn btn-secondary" onclick="navigate('next')">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    <h2 id="calendarTitle"></h2>
</div>
<div class="view-switcher btn-group">
    <button id="day-view-btn" class="btn btn-secondary" onclick="switchView('day')">Day</button>
    <button id="week-view-btn" class="btn btn-secondary" onclick="switchView('week')">Week</button>
    <button id="month-view-btn" class="btn btn-secondary active" onclick="switchView('month')">Month</button>
</div>
{% endblock %}

{% block content %}
<div class="calendar-page-container">
    <div class="calendar-sidebar">
        <div class="calendar-sidebar-section">
            <h4>Databases</h4>
            <div id="database-filter-tree">
                <!-- Database filter tree is generated here by JS -->
            </div>
        </div>
        <!-- The task detail sidebar will be injected here if not already in base.html -->
    </div>
    <div class="calendar-main">
        <div id="calendar-views">
            <!-- Month View -->
            <div id="month-view" class="view">
                <div class="month-grid-header">
                    <div class="weekday">Sun</div>
                    <div class="weekday">Mon</div>
                    <div class="weekday">Tue</div>
                    <div class="weekday">Wed</div>
                    <div class="weekday">Thu</div>
                    <div class="weekday">Fri</div>
                    <div class="weekday">Sat</div>
                </div>
                <div class="month-grid-body" id="monthGridBody"></div>
            </div>

            <!-- Week View -->
            <div id="week-view" class="view" style="display:none;">
                <div class="time-grid-header">
                    <!-- Week view header content generated by JS -->
                </div>
                <div class="time-grid-scroll-container">
                    <div class="time-grid-container">
                        <div class="time-col"></div>
                        <div class="time-grid-body"></div>
                    </div>
                </div>
            </div>

            <!-- Day View -->
            <div id="day-view" class="view" style="display:none;">
                 <div class="time-grid-header">
                    <!-- Day view header content generated by JS -->
                </div>
                <div class="time-grid-scroll-container">
                    <div class="time-grid-container">
                        <div class="time-col"></div>
                        <div class="time-grid-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* General Calendar Navigation & Layout */
.calendar-nav { display: flex; align-items: center; gap: 12px; }
#calendarTitle { font-size: 22px; margin: 0; }
.nav-arrows { display: flex; }
.nav-arrows .btn { border-radius: 0; }
.nav-arrows .btn:first-child { border-top-left-radius: 4px; border-bottom-left-radius: 4px; }
.nav-arrows .btn:last-child { border-top-right-radius: 4px; border-bottom-right-radius: 4px; }

.calendar-page-container { display: flex; height: calc(100vh - 120px); }
.calendar-sidebar { width: 250px; background: #121212; padding: 15px; border-right: 1px solid #333; }
.calendar-main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
#calendar-views { flex-grow: 1; position: relative; }
.view { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; }

/* Month View */
#month-view { display: flex; }
.month-grid-header { display: grid; grid-template-columns: repeat(7, 1fr); background: #1e1e1e; border-bottom: 1px solid #333;}
.month-grid-header .weekday { text-align: center; padding: 10px 0; font-weight: 500; font-size: 13px; color: #aaa; }
.month-grid-body { display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: minmax(120px, 1fr); flex-grow: 1; }
.calendar-day { border-top: 1px solid #333; border-left: 1px solid #333; padding: 8px; position: relative; overflow-y: auto; }
.calendar-day:nth-child(7n+1) { border-left: none; }
.day-number { font-size: 13px; text-align: right; margin-bottom: 4px; }
.calendar-day.not-current-month .day-number { color: #666; }
.calendar-day.today .day-number { background: #4a9eff; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; float: right; }
.day-events { margin-top: 5px; }
.calendar-event { background: #2a2a2a; color: white; padding: 3px 6px; border-radius: 4px; font-size: 12px; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; border-left: 3px solid #4a9eff; }
.calendar-event.completed { text-decoration: line-through; background: #444; border-left-color: #666; }


/* --- Week/Day View (FIXED) --- */
.time-grid-header {
    display: flex;
    flex-direction: column;
    border-bottom: 1px solid #333;
    background: #1e1e1e;
    position: relative;
}

.date-header-row, .all-day-strip {
    display: grid; /* Use Grid for consistent column layout */
    /* grid-template-columns is set dynamically by JS */
    align-items: stretch;
}

.time-col-gutter {
    grid-column: 1 / 2;
    text-align: center;
    color: #888;
    font-size: 11px;
    padding-top: 5px;
    border-right: 1px solid #333;
}

.day-header-cell {
    text-align: center;
    padding: 8px 0;
    border-left: 1px solid #333;
}
.day-header-cell:first-of-type {
    border-left: none;
}

/* Style for "Today" header in Week/Day view (FIXED) */
.day-header-cell.today .day-date {
    background: #4a9eff;
    color: white;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.all-day-strip {
    min-height: 28px;
    border-top: 1px solid #333;
    background: #181818;
}

.all-day-day-col {
    border-left: 1px solid #333;
    padding: 2px 5px;
    min-height: 28px;
}
.all-day-day-col:first-of-type {
    border-left: none;
}

.time-grid-scroll-container {
    flex-grow: 1;
    overflow-y: scroll;
    overflow-x: hidden;
}

.time-grid-container {
    display: flex; /* Use flex to position time column and body */
    position: relative;
}

.time-col {
    width: 60px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    text-align: right;
    font-size: 12px;
    color: #888;
    border-right: 1px solid #333;
}
.time-col > div {
    height: 60px;
    padding-right: 10px;
    border-top: 1px solid #333;
    position: relative;
    top: -8px; /* Align text with lines */
}
.time-col > div:first-child {
    border-top: none;
}

.time-grid-body {
    flex-grow: 1;
    display: grid; /* Use Grid for body columns to align with header */
    position: relative;
    background-image: linear-gradient(to bottom, #333 1px, transparent 1px);
    background-size: 100% 60px;
}

.day-col {
    border-left: 1px solid #333;
    position: relative;
}
.day-col:first-child {
    border-left: none;
}

.timed-event {
    position: absolute;
    left: 5px;
    right: 5px;
    background: #2a2a2a;
    color: white;
    padding: 5px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 1;
    overflow: hidden;
    border-left: 3px solid #4a9eff;
}
.timed-event.completed {
    text-decoration: line-through;
    background: #444;
    border-left-color: #666;
}


/* Sidebar & Filter Styles */
.calendar-sidebar-section { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333; }
.calendar-sidebar-section:last-child { border-bottom: none; }
.calendar-sidebar-section h4 { font-size: 18px; margin-bottom: 10px; color: #fff; }
#database-filter-tree { max-height: 400px; overflow-y: auto; }
.database-filter-item { padding: 8px 0; border-bottom: 1px solid #333; display: flex; align-items: center; }
.database-filter-item label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
.db-color-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
.all-toggle { font-weight: 500; }
.all-toggle label { margin: 0; }
</style>

<script>
let currentDate = new Date();
let currentView = 'month'; // 'month', 'week', 'day'
const calendarItems = {{ calendar_items | tojson }};
const allDatabases = {{ data.databases | tojson }};
const completionLogs = {{ completion_logs | tojson }};
let activeDatabaseIds = Object.keys(allDatabases);

// --- Helper: Parse YYYY-MM-DD as local date to avoid timezone issues ---
function parseLocalDate(dateString) {
    if (!dateString) return null;
    const [year, month, day] = dateString.split('-').map(Number);
    return new Date(year, month - 1, day);
}

document.addEventListener('DOMContentLoaded', function() {
    buildDatabaseFilterTree();
    renderCalendar();
});

function buildDatabaseFilterTree() {
    const container = document.getElementById('database-filter-tree');
    if (!container) return;
    container.innerHTML = '';

    const allToggleItem = document.createElement('div');
    allToggleItem.className = 'database-filter-item all-toggle';
    allToggleItem.innerHTML = `
        <label>
            <input type="checkbox" id="all-db-toggle" checked>
            <strong>Show/Hide All</strong>
        </label>
    `;
    container.appendChild(allToggleItem);

    for (const dbId in allDatabases) {
        const db = allDatabases[dbId];
        const item = document.createElement('div');
        item.className = 'database-filter-item';
        item.innerHTML = `
            <label>
                <input type="checkbox" class="db-filter-checkbox" value="${db.id}" checked>
                <span class="db-color-dot" style="background-color: ${db.color};"></span>
                <span>${db.name}</span>
            </label>
        `;
        container.appendChild(item);
    }

    document.getElementById('all-db-toggle').addEventListener('change', function(e) {
        const isChecked = e.target.checked;
        document.querySelectorAll('.db-filter-checkbox').forEach(checkbox => checkbox.checked = isChecked);
        updateActiveDatabasesAndRender();
    });

    document.querySelectorAll('.db-filter-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateActiveDatabasesAndRender);
    });
}

function updateActiveDatabasesAndRender() {
    activeDatabaseIds = Array.from(document.querySelectorAll('.db-filter-checkbox:checked')).map(cb => cb.value);
    
    const allCheckboxes = document.querySelectorAll('.db-filter-checkbox');
    const allToggle = document.getElementById('all-db-toggle');
    if (activeDatabaseIds.length === allCheckboxes.length) {
        allToggle.checked = true;
        allToggle.indeterminate = false;
    } else if (activeDatabaseIds.length === 0) {
        allToggle.checked = false;
        allToggle.indeterminate = false;
    } else {
        allToggle.indeterminate = true;
    }

    renderCalendar();
}

function switchView(view) {
    currentView = view;
    document.querySelectorAll('.view-switcher .btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`${view}-view-btn`).classList.add('active');
    
    document.querySelectorAll('#calendar-views .view').forEach(v => v.style.display = 'none');
    document.getElementById(`${view}-view`).style.display = 'flex';
    
    renderCalendar();
}

function navigate(direction) {
    const d = direction === 'next' ? 1 : -1;
    if (currentView === 'month') {
        currentDate.setMonth(currentDate.getMonth() + d, 1);
    } else if (currentView === 'week') {
        currentDate.setDate(currentDate.getDate() + (d * 7));
    } else if (currentView === 'day') {
        currentDate.setDate(currentDate.getDate() + d);
    }
    renderCalendar();
}

function goToToday() {
    currentDate = new Date();
    renderCalendar();
}

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function renderCalendar() {
    if (currentView === 'month') {
        renderMonthView();
    } else if (currentView === 'week') {
        renderWeekView();
    } else if (currentView === 'day') {
        renderDayView();
    }
}

function renderMonthView() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    document.getElementById('calendarTitle').textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

    const gridBody = document.getElementById('monthGridBody');
    gridBody.innerHTML = '';
    
    const firstDayOfMonth = new Date(year, month, 1);
    const startDate = new Date(firstDayOfMonth);
    startDate.setDate(startDate.getDate() - firstDayOfMonth.getDay());

    const numDaysToRender = 42; // Always render 6 weeks for a consistent layout

    for (let i = 0; i < numDaysToRender; i++) {
        const day = new Date(startDate);
        day.setDate(startDate.getDate() + i);
        
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        if (day.getMonth() !== month) dayEl.classList.add('not-current-month');
        if (formatDate(day) === formatDate(new Date())) dayEl.classList.add('today');
        
        dayEl.innerHTML = `<div class="day-number">${day.getDate()}</div><div class="day-events"></div>`;
        
        const eventsContainer = dayEl.querySelector('.day-events');
        const dateString = formatDate(day);

        const dayEvents = calendarItems.filter(item => {
            return item.date === dateString && activeDatabaseIds.includes(item.page.parent_database_id);
        });
        
        dayEvents.forEach(event => {
            const eventEl = document.createElement('div');
            eventEl.className = 'calendar-event';
            if (completionLogs[event.page.id]?.find(log => log.date === dateString && log.completed)) {
                eventEl.classList.add('completed');
            }
            eventEl.textContent = event.page.title;
            eventEl.style.borderLeftColor = event.database_color;
            eventEl.onclick = () => showTaskDetails(event.page, event.date);
            eventsContainer.appendChild(eventEl);
        });
        
        gridBody.appendChild(dayEl);
    }
}

/**
 * Renders the entire time grid for Week and Day views. (REFACTORED & FIXED)
 * @param {number} numDays - The number of days to render (7 for week, 1 for day).
 */
function renderTimeGrid(numDays) {
    const viewId = numDays === 1 ? 'day-view' : 'week-view';
    const viewContainer = document.getElementById(viewId);
    const headerContainer = viewContainer.querySelector('.time-grid-header');
    const timeCol = viewContainer.querySelector('.time-col');
    const body = viewContainer.querySelector('.time-grid-body');
    
    headerContainer.innerHTML = '';
    timeCol.innerHTML = '';
    body.innerHTML = '';

    // --- 1. Calculate the start date for the view (normalized to midnight) ---
    const startDate = new Date(currentDate);
    if (numDays === 7) {
        startDate.setDate(startDate.getDate() - startDate.getDay());
    }
    startDate.setHours(0, 0, 0, 0);

    // --- 2. Define Grid Column Layout ---
    const gridTemplateColumns = `60px repeat(${numDays}, 1fr)`;

    // --- 3. Render Header Rows (Date and All-Day) ---
    const dateHeaderRow = document.createElement('div');
    dateHeaderRow.className = 'date-header-row';
    dateHeaderRow.style.gridTemplateColumns = gridTemplateColumns;
    dateHeaderRow.appendChild(Object.assign(document.createElement('div'), { className: 'time-col-gutter' }));
    
    const allDayStrip = document.createElement('div');
    allDayStrip.className = 'all-day-strip';
    allDayStrip.style.gridTemplateColumns = gridTemplateColumns;
    allDayStrip.appendChild(Object.assign(document.createElement('div'), { className: 'time-col-gutter', innerHTML: 'all-day' }));
    
    // --- 4. Render Body Grid ---
    body.style.display = 'grid';
    body.style.gridTemplateColumns = `repeat(${numDays}, 1fr)`;
    body.style.position = 'relative';

    for (let i = 0; i < numDays; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        const dateString = formatDate(date);

        // Create Date Header Cell
        const headerCell = document.createElement('div');
        headerCell.className = 'day-header-cell';
        headerCell.innerHTML = `<div class="day-name">${date.toLocaleString('default', { weekday: 'short' })}</div><div class="day-date">${date.getDate()}</div>`;
        if (dateString === formatDate(new Date())) {
            headerCell.classList.add('today');
        }
        dateHeaderRow.appendChild(headerCell);

        // Create All-Day Column
        const allDayCol = document.createElement('div');
        allDayCol.className = 'all-day-day-col';
        allDayCol.dataset.date = dateString;
        allDayStrip.appendChild(allDayCol);

        // Create Body Column
        const dayCol = document.createElement('div');
        dayCol.className = 'day-col';
        dayCol.dataset.date = dateString;
        dayCol.style.position = 'relative';
        body.appendChild(dayCol);
    }

    headerContainer.appendChild(dateHeaderRow);
    headerContainer.appendChild(allDayStrip);

    // --- 5. Render Time Labels (AM/PM) ---
    for (let i = 0; i < 24; i++) {
        const timeLabel = document.createElement('div');
        if (i > 0) {
            const hour = i % 12 === 0 ? 12 : i % 12;
            const ampm = i < 12 ? 'AM' : 'PM';
            timeLabel.textContent = `${hour} ${ampm}`;
        }
        timeCol.appendChild(timeLabel);
    }
    
    // --- 6. Place events on the newly rendered grid ---
    placeEventsInTimeGrid(startDate, numDays);
}


function renderWeekView() {
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    document.getElementById('calendarTitle').textContent = 
        `${startOfWeek.toLocaleString('default', {month: 'long', day: 'numeric'})} - ${endOfWeek.toLocaleString('default', {month: 'long', day: 'numeric', year: 'numeric'})}`;
    
    renderTimeGrid(7);
}

function renderDayView() {
    document.getElementById('calendarTitle').textContent = 
        currentDate.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    
    renderTimeGrid(1);
}

/**
 * Places events into the week or day view grid. (FIXED)
 * @param {Date} viewStartDate - The normalized (midnight) start date of the view.
 * @param {number} numDays - The number of days in the view.
 */
function placeEventsInTimeGrid(viewStartDate, numDays) {
    const viewEndDate = new Date(viewStartDate);
    viewEndDate.setDate(viewStartDate.getDate() + numDays);

    const eventsInView = calendarItems.filter(item => {
        const itemDate = parseLocalDate(item.date);
        // Compare normalized dates to correctly filter events for the view
        return itemDate && itemDate >= viewStartDate && itemDate < viewEndDate && activeDatabaseIds.includes(item.page.parent_database_id);
    });

    // Debug: Log which events are being placed and which columns exist
    console.log('Placing events for view:', {
        viewStartDate,
        numDays,
        eventsInView,
        dayCols: Array.from(document.querySelectorAll('.day-col')).map(col => col.dataset.date),
        allDayCols: Array.from(document.querySelectorAll('.all-day-day-col')).map(col => col.dataset.date)
    });

    eventsInView.forEach(event => {
        const dateString = event.date;
        const isCompleted = completionLogs[event.page.id]?.find(log => log.date === dateString && log.completed);

        if (event.is_all_day) {
            const allDayCol = document.querySelector(`.all-day-day-col[data-date="${dateString}"]`);
            if (allDayCol) {
                const eventEl = document.createElement('div');
                eventEl.className = 'calendar-event';
                if (isCompleted) eventEl.classList.add('completed');
                eventEl.textContent = event.page.title;
                eventEl.style.borderLeftColor = event.database_color;
                eventEl.onclick = () => showTaskDetails(event.page, event.date);
                allDayCol.appendChild(eventEl);
            } else {
                console.warn('No allDayCol found for', dateString);
            }
        } else if (event.start_time) {
            const dayCol = document.querySelector(`.day-col[data-date="${dateString}"]`);
            if (!dayCol) {
                console.warn('No dayCol found for', dateString);
                return;
            }

            const [startHour, startMinute] = event.start_time.split(':').map(Number);
            const end = event.end_time ? event.end_time.split(':').map(Number) : [startHour + 1, startMinute];
            const [endHour, endMinute] = end;

            const startTotalMinutes = startHour * 60 + startMinute;
            const endTotalMinutes = endHour * 60 + endMinute;

            const top = (startTotalMinutes / 60) * 60; // 60px per hour
            const height = ((endTotalMinutes - startTotalMinutes) / 60) * 60;

            const timedEventEl = document.createElement('div');
            timedEventEl.className = 'timed-event';
            if (isCompleted) timedEventEl.classList.add('completed');
            timedEventEl.style.top = `${top}px`;
            timedEventEl.style.height = `${Math.max(20, height)}px`;
            timedEventEl.style.borderLeftColor = event.database_color;
            timedEventEl.textContent = event.page.title;
            timedEventEl.onclick = () => showTaskDetails(event.page, event.date);

            dayCol.appendChild(timedEventEl);
        }
    });
}


// --- Functions for showing task details in a sidebar ---
// (Assuming these are still relevant and functional)

function showTaskDetails(page, date) {
    // This function seems complex and wasn't reported as broken.
    // Leaving it as is, but it would be called by the event click handlers.
    console.log("Showing details for:", page.title, "on", date);
    // You would typically populate a sidebar or modal here.
    // Example:
    // const sidebar = document.getElementById('task-detail-sidebar');
    // sidebar.querySelector('.title').textContent = page.title;
    // ... etc ...
    // sidebar.classList.add('is-visible');
}

function markTaskCompleted(pageId, date, completed) {
    fetch('/api/mark_completed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ page_id: pageId, date: date, completed: completed })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Simple reload to show changes
        } else {
            console.error('Failed to update task status.');
        }
    });
}

function openPage(pageId) {
    window.location.href = `/page/${pageId}`;
}

function editPage(pageId) {
    // Needs implementation, e.g., redirect to an edit form
    console.log("Editing page:", pageId);
}

</script>
{% endblock %}
