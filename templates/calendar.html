{% extends "base.html" %}

{% block title %}Calendar - Notion Alternative{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('index') }}">Home</a>
<span class="breadcrumb-separator">/</span>
<span>Calendar</span>
{% endblock %}

{% block top_bar_actions %}
<button class="btn btn-secondary" onclick="previousMonth()">
    <i class="fas fa-chevron-left"></i>
</button>
<button class="btn btn-secondary" onclick="nextMonth()">
    <i class="fas fa-chevron-right"></i>
</button>
<button class="btn btn-primary" onclick="goToToday()">
    Today
</button>
{% endblock %}

{% block content %}
<div class="calendar-container">
    <div class="calendar-header">
        <h2 id="currentMonth">Calendar</h2>
    </div>
    
    <div class="calendar-grid">
        <div class="calendar-weekdays">
            <div class="weekday">Sun</div>
            <div class="weekday">Mon</div>
            <div class="weekday">Tue</div>
            <div class="weekday">Wed</div>
            <div class="weekday">Thu</div>
            <div class="weekday">Fri</div>
            <div class="weekday">Sat</div>
        </div>
        
        <div class="calendar-days" id="calendarDays">
            <!-- Calendar days will be generated by JavaScript -->
        </div>
    </div>
</div>

<script>
let currentDate = new Date();
let currentMonth = currentDate.getMonth();
let currentYear = currentDate.getFullYear();

// Calendar items from server
const calendarItems = {{ calendar_items | tojson }};

document.addEventListener('DOMContentLoaded', function() {
    renderCalendar(calendarItems, currentMonth, currentYear);
});

function previousMonth() {
    currentMonth--;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    }
    renderCalendar(calendarItems, currentMonth, currentYear);
}

function nextMonth() {
    currentMonth++;
    if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    renderCalendar(calendarItems, currentMonth, currentYear);
}

function goToToday() {
    currentDate = new Date();
    currentMonth = currentDate.getMonth();
    currentYear = currentDate.getFullYear();
    renderCalendar(calendarItems, currentMonth, currentYear);
}

function renderCalendar(calendarItems, currentMonth, currentYear) {
    const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
    
    const calendarDays = document.getElementById('calendarDays');
    calendarDays.innerHTML = '';
    
    // Get first day of month and number of days
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    // Generate calendar grid
    for (let week = 0; week < 6; week++) {
        for (let day = 0; day < 7; day++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + (week * 7) + day);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            // Check if it's current month
            if (date.getMonth() === currentMonth) {
                dayElement.classList.add('current-month');
            }
            
            // Check if it's today
            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
                dayElement.classList.add('today');
            }
            
            // Add day number
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = date.getDate();
            dayElement.appendChild(dayNumber);
            
            // Add events for this day
            const eventsContainer = document.createElement('div');
            eventsContainer.className = 'day-events';
            
            const dateString = formatDate(date);
            const dayEvents = calendarItems.filter(item => {
                try {
                    const eventDate = new Date(item.date);
                    // Check if the date is valid
                    if (isNaN(eventDate.getTime())) {
                        return false;
                    }
                    return eventDate.toDateString() === date.toDateString();
                } catch (error) {
                    console.warn('Invalid date in calendar item:', item.date);
                    return false;
                }
            });
            
            dayEvents.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = 'calendar-event';
                
                // Check if page has description
                const description = event.page.properties.description ? event.page.properties.description.value : '';
                if (description) {
                    eventElement.classList.add('has-description');
                    eventElement.setAttribute('data-description', description);
                }
                
                eventElement.textContent = event.page.title;
                eventElement.onclick = () => showTaskDetails(event.page, dateString);
                
                if (event.is_repeating) {
                    eventElement.classList.add('repeating');
                }
                
                // Add nested databases indicator
                if (event.page.databases && event.page.databases.length > 0) {
                    eventElement.classList.add('has-nested-databases');
                }
                
                eventsContainer.appendChild(eventElement);
            });
            
            dayElement.appendChild(eventsContainer);
            calendarDays.appendChild(dayElement);
        }
    }
}

function showTaskDetails(page, date) {
    fetch(`/api/get_page_data/${page.id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const pageData = data.page;
                const completionLogs = data.completion_logs;
                
                // Check if task is completed for this date
                const completionLog = completionLogs.find(log => log.date === date);
                const isCompleted = completionLog ? completionLog.completed : false;
                
                // Get hierarchy for this page
                return fetch(`/api/get_page_hierarchy/${page.id}`)
                    .then(response => response.json())
                    .then(hierarchyData => {
                        const hierarchy = hierarchyData.success ? hierarchyData.hierarchy : [];
                        
                        // Build task details HTML
                        let detailsHtml = `
                            <div class="task-details">
                                <h3>${pageData.title}</h3>
                        `;
                        
                        // Add hierarchy breadcrumb
                        if (hierarchy.length > 0) {
                            detailsHtml += `
                                <div class="task-hierarchy">
                                    <label>Location:</label>
                                    <div class="hierarchy-path">
                            `;
                            
                            hierarchy.forEach((item, index) => {
                                if (index > 0) {
                                    detailsHtml += '<span class="hierarchy-separator">/</span>';
                                }
                                detailsHtml += `<span class="hierarchy-item">${item.title}</span>`;
                            });
                            
                            detailsHtml += `
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Add nested databases if any
                        if (pageData.databases && pageData.databases.length > 0) {
                            detailsHtml += `
                                <div class="task-nested-databases">
                                    <label>Nested Databases:</label>
                                    <div class="nested-databases-list">
                            `;
                            
                            pageData.databases.forEach(dbId => {
                                // This would need to be fetched from the server
                                // For now, we'll show a placeholder
                                detailsHtml += `
                                    <div class="nested-database-item">
                                        <i class="fas fa-database"></i>
                                        <span>Database ${dbId.substring(0, 8)}...</span>
                                    </div>
                                `;
                            });
                            
                            detailsHtml += `
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Add description if it exists
                        const description = pageData.properties.description ? pageData.properties.description.value : '';
                        if (description) {
                            detailsHtml += `
                                <div class="task-description">${description}</div>
                            `;
                        }
                        
                        detailsHtml += `
                                <div class="task-properties">
                        `;
                        
                        // Add properties (excluding description since we already showed it)
                        Object.values(pageData.properties).forEach(prop => {
                            if (prop.value && prop.name !== 'Description') {
                                detailsHtml += `
                                    <div class="task-property">
                                        <label>${prop.name}:</label>
                                        <span>${prop.value}</span>
                                    </div>
                                `;
                            }
                        });
                        
                        detailsHtml += `
                                </div>
                                <div class="task-actions">
                                    <label class="checkbox-container">
                                        <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                                               onchange="toggleTaskCompletion('${pageData.id}', '${date}', this.checked)">
                                        <span class="checkmark"></span>
                                        Mark as completed for ${date}
                                    </label>
                                    <button class="btn btn-sm btn-primary" onclick="openTaskPage('${pageData.id}')">
                                        <i class="fas fa-external-link-alt"></i>
                                        Open Task
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // Show in sidebar
                        document.getElementById('taskSidebarTitle').textContent = pageData.title;
                        document.getElementById('taskSidebarContent').innerHTML = detailsHtml;
                        document.getElementById('taskSidebar').classList.add('active');
                    });
            }
        })
        .catch(error => {
            console.error('Error loading task details:', error);
        });
}

function openTaskPage(pageId) {
    window.location.href = `/api/navigate_to_page/${pageId}`;
}

function toggleTaskCompletion(pageId, date, completed) {
    return fetch('/api/mark_completed', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            page_id: pageId,
            date: date,
            completed: completed
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Task completion updated');
        }
    })
    .catch(error => {
        console.error('Error updating task completion:', error);
    });
}

function formatDate(date) {
    try {
        if (isNaN(date.getTime())) {
            return '';
        }
        return date.toISOString().split('T')[0];
    } catch (error) {
        console.warn('Invalid date in formatDate:', date);
        return '';
    }
}
</script>
{% endblock %} 