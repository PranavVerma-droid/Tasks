{% extends "base.html" %}

{% block title %}Calendar - Task Manager{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('index') }}">Home</a>
<span class="breadcrumb-separator">/</span>
<span>Calendar</span>
{% endblock %}

{% block top_bar_actions %}
<div class="calendar-nav">
    <button class="btn btn-primary" id="todayBtn">Today</button>
    <div class="nav-arrows">
        <button class="btn btn-secondary" id="prevBtn">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button class="btn btn-secondary" id="nextBtn">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    <h2 id="calendarTitle"></h2>
</div>
<div class="view-switcher btn-group">
    <button id="dayGridMonthBtn" class="btn btn-secondary active">Month</button>
    <button id="timeGridWeekBtn" class="btn btn-secondary">Week</button>
    <button id="timeGridDayBtn" class="btn btn-secondary">Day</button>
    <button id="listWeekBtn" class="btn btn-secondary">Agenda</button>
</div>
{% endblock %}

{% block content %}
<div class="calendar-page-container">
    <div class="calendar-sidebar">
        <div class="calendar-sidebar-section">
            <h4>Databases</h4>
            <div id="database-filter-tree">
                <!-- Database filter tree is generated here by JS -->
            </div>
        </div>
    </div>
    <div class="calendar-main">
        <div id="calendar"></div>
    </div>
</div>

<!-- Task Detail Modal -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="taskModalTitle">Task Details</h3>
            <span class="close" id="taskModalClose">&times;</span>
        </div>
        <div class="modal-body" id="taskModalBody">
            <!-- Task details will be populated here -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="taskModalCloseBtn">Close</button>
            <button class="btn btn-primary" id="taskModalOpenBtn">Open Page</button>
        </div>
    </div>
</div>

<style>
/* Calendar Layout */
.calendar-page-container {
    display: flex;
    height: calc(100vh - 120px);
}

.calendar-sidebar {
    width: 250px;
    background: #121212;
    padding: 15px;
    border-right: 1px solid #333;
}

.calendar-main {
    flex-grow: 1;
    padding: 20px;
    overflow: hidden;
}

/* Calendar Navigation */
.calendar-nav {
    display: flex;
    align-items: center;
    gap: 12px;
}

#calendarTitle {
    font-size: 22px;
    margin: 0;
}

.nav-arrows {
    display: flex;
}

.nav-arrows .btn {
    border-radius: 0;
}

.nav-arrows .btn:first-child {
    border-top-left-radius: 4px;
    border-bottom-left-radius: 4px;
}

.nav-arrows .btn:last-child {
    border-top-right-radius: 4px;
    border-bottom-right-radius: 4px;
}

/* Sidebar & Filter Styles */
.calendar-sidebar-section {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #333;
}

.calendar-sidebar-section:last-child {
    border-bottom: none;
}

.calendar-sidebar-section h4 {
    font-size: 18px;
    margin-bottom: 10px;
    color: #fff;
}

#database-filter-tree {
    max-height: 400px;
    overflow-y: auto;
}

.database-filter-item {
    padding: 8px 0;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center;
}

.database-filter-item label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.db-color-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.all-toggle {
    font-weight: 500;
}

.all-toggle label {
    margin: 0;
}

/* FullCalendar Theme Overrides for Dark Mode */
.fc {
    color: #fff;
}

.fc-theme-standard .fc-scrollgrid {
    border: 1px solid #333;
}

.fc-theme-standard td, .fc-theme-standard th {
    border: 1px solid #333;
}

.fc-theme-standard .fc-scrollgrid-sync-table tbody tr:first-child td {
    border-top: 0;
}

.fc-theme-standard .fc-scrollgrid-sync-table tbody tr:last-child td {
    border-bottom: 0;
}

.fc .fc-daygrid-day-frame {
    background: #1e1e1e;
}

.fc .fc-col-header-cell {
    background: #2d2d2d;
    color: #aaa;
}

.fc .fc-timegrid-slot {
    border-color: #333;
}

.fc .fc-timegrid-slot-label {
    color: #888;
}

.fc .fc-daygrid-day.fc-day-today {
    background-color: rgba(74, 158, 255, 0.1);
}

.fc .fc-day-today .fc-daygrid-day-number {
    background: #4a9eff;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: auto;
}

.fc-event {
    border-left-width: 3px !important;
    background: #2a2a2a !important;
    border-color: #4a9eff !important;
    color: white !important;
}

.fc-event.completed {
    text-decoration: line-through;
    background: #444 !important;
    border-color: #666 !important;
    opacity: 0.7;
}

.fc-event-title {
    font-size: 12px;
}

.fc .fc-button-primary {
    background-color: #4a9eff;
    border-color: #4a9eff;
    color: white;
}

.fc .fc-button-primary:hover {
    background-color: #3a8eef;
    border-color: #3a8eef;
}

.fc .fc-button-primary:disabled {
    background-color: #666;
    border-color: #666;
}

.fc-toolbar {
    display: none !important; /* Hide default toolbar since we have our own */
}

/* Task Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #2d2d2d;
    margin: 5% auto;
    padding: 0;
    border: 1px solid #333;
    border-radius: 8px;
    width: 500px;
    max-width: 90%;
    color: white;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: white;
}

.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #333;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.task-detail-item {
    margin-bottom: 15px;
}

.task-detail-label {
    font-weight: bold;
    color: #aaa;
    margin-bottom: 5px;
}

.task-detail-value {
    color: white;
}

.completion-toggle {
    margin-top: 15px;
}
</style>

<!-- Include FullCalendar CSS and JS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.min.js"></script>

<script>
// Global variables
let calendar;
const calendarItems = {{ calendar_items | tojson }};
const allDatabases = {{ data.databases | tojson }};
const completionLogs = {{ completion_logs | tojson }};
let activeDatabaseIds = Object.keys(allDatabases);
let currentTaskModal = null;

// Helper: Parse YYYY-MM-DD as local date to avoid timezone issues
function parseLocalDate(dateString) {
    if (!dateString) return null;
    const [year, month, day] = dateString.split('-').map(Number);
    return new Date(year, month - 1, day);
}

document.addEventListener('DOMContentLoaded', function() {
    initializeCalendar();
    buildDatabaseFilterTree();
});

function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: false, // We'll use our custom toolbar
        height: '100%',
        
        // Event sources
        events: function(info, successCallback, failureCallback) {
            const events = getFilteredEvents();
            successCallback(events);
        },
        
        // Event rendering
        eventDidMount: function(info) {
            // Add completion styling
            const event = info.event;
            if (event.extendedProps.completed) {
                info.el.classList.add('completed');
            }
            
            // Set border color from database
            if (event.extendedProps.databaseColor) {
                info.el.style.borderLeftColor = event.extendedProps.databaseColor;
            }
        },
        
        // Event click handler
        eventClick: function(info) {
            showTaskModal(info.event.extendedProps.page, info.event.extendedProps.date);
        },
        
        // Date click handler for creating new events
        dateClick: function(info) {
            console.log('Date clicked:', info.dateStr);
            // You could open a "create new task" modal here
        },
        
        // View change handler
        viewDidMount: function(view) {
            updateCalendarTitle();
        }
    });
    
    calendar.render();
    
    // Setup custom navigation
    setupCustomNavigation();
}

function setupCustomNavigation() {
    // Today button
    document.getElementById('todayBtn').addEventListener('click', function() {
        calendar.today();
        updateCalendarTitle();
    });
    
    // Previous/Next buttons
    document.getElementById('prevBtn').addEventListener('click', function() {
        calendar.prev();
        updateCalendarTitle();
    });
    
    document.getElementById('nextBtn').addEventListener('click', function() {
        calendar.next();
        updateCalendarTitle();
    });
    
    // View switcher buttons
    document.getElementById('dayGridMonthBtn').addEventListener('click', function() {
        calendar.changeView('dayGridMonth');
        updateViewSwitcher('dayGridMonthBtn');
    });
    
    document.getElementById('timeGridWeekBtn').addEventListener('click', function() {
        calendar.changeView('timeGridWeek');
        updateViewSwitcher('timeGridWeekBtn');
    });
    
    document.getElementById('timeGridDayBtn').addEventListener('click', function() {
        calendar.changeView('timeGridDay');
        updateViewSwitcher('timeGridDayBtn');
    });
    
    document.getElementById('listWeekBtn').addEventListener('click', function() {
        calendar.changeView('listWeek');
        updateViewSwitcher('listWeekBtn');
    });
}

function updateViewSwitcher(activeButtonId) {
    document.querySelectorAll('.view-switcher .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(activeButtonId).classList.add('active');
}

function updateCalendarTitle() {
    const view = calendar.view;
    const title = view.title;
    document.getElementById('calendarTitle').textContent = title;
}

function getFilteredEvents() {
    const events = [];
    
    calendarItems.forEach(item => {
        if (!activeDatabaseIds.includes(item.page.parent_database_id)) {
            return; // Skip if database is filtered out
        }
        
        const isCompleted = completionLogs[item.page.id]?.find(log => 
            log.date === item.date && log.completed
        );
        
        const event = {
            id: `${item.page.id}_${item.date}`,
            title: item.page.title,
            start: item.date,
            allDay: item.is_all_day,
            backgroundColor: '#2a2a2a',
            borderColor: item.database_color,
            textColor: 'white',
            extendedProps: {
                page: item.page,
                date: item.date,
                completed: !!isCompleted,
                databaseColor: item.database_color,
                isAllDay: item.is_all_day
            }
        };
        
        // Add time information for timed events
        if (!item.is_all_day && item.start_time) {
            event.start = `${item.date}T${item.start_time}`;
            if (item.end_time) {
                event.end = `${item.date}T${item.end_time}`;
            }
        }
        
        events.push(event);
    });
    
    return events;
}

function buildDatabaseFilterTree() {
    const container = document.getElementById('database-filter-tree');
    if (!container) return;
    container.innerHTML = '';

    // All toggle
    const allToggleItem = document.createElement('div');
    allToggleItem.className = 'database-filter-item all-toggle';
    allToggleItem.innerHTML = `
        <label>
            <input type="checkbox" id="all-db-toggle" checked>
            <strong>Show/Hide All</strong>
        </label>
    `;
    container.appendChild(allToggleItem);

    // Individual database filters
    for (const dbId in allDatabases) {
        const db = allDatabases[dbId];
        const item = document.createElement('div');
        item.className = 'database-filter-item';
        item.innerHTML = `
            <label>
                <input type="checkbox" class="db-filter-checkbox" value="${db.id}" checked>
                <span class="db-color-dot" style="background-color: ${db.color};"></span>
                <span>${db.name}</span>
            </label>
        `;
        container.appendChild(item);
    }

    // Event listeners
    document.getElementById('all-db-toggle').addEventListener('change', function(e) {
        const isChecked = e.target.checked;
        document.querySelectorAll('.db-filter-checkbox').forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        updateActiveDatabasesAndRefresh();
    });

    document.querySelectorAll('.db-filter-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateActiveDatabasesAndRefresh);
    });
}

function updateActiveDatabasesAndRefresh() {
    activeDatabaseIds = Array.from(document.querySelectorAll('.db-filter-checkbox:checked'))
        .map(cb => cb.value);
    
    // Update all toggle state
    const allCheckboxes = document.querySelectorAll('.db-filter-checkbox');
    const allToggle = document.getElementById('all-db-toggle');
    if (activeDatabaseIds.length === allCheckboxes.length) {
        allToggle.checked = true;
        allToggle.indeterminate = false;
    } else if (activeDatabaseIds.length === 0) {
        allToggle.checked = false;
        allToggle.indeterminate = false;
    } else {
        allToggle.indeterminate = true;
    }

    // Refresh calendar events
    calendar.refetchEvents();
}

function showTaskModal(page, date) {
    currentTaskModal = { page, date };
    
    const modal = document.getElementById('taskModal');
    const title = document.getElementById('taskModalTitle');
    const body = document.getElementById('taskModalBody');
    const openBtn = document.getElementById('taskModalOpenBtn');
    
    title.textContent = page.title;
    
    // Build task details
    let detailsHtml = `
        <div class="task-detail-item">
            <div class="task-detail-label">Date:</div>
            <div class="task-detail-value">${date}</div>
        </div>
    `;
    
    if (page.properties.description && page.properties.description.rich_text_content) {
        detailsHtml += `
            <div class="task-detail-item">
                <div class="task-detail-label">Description:</div>
                <div class="task-detail-value">${page.properties.description.rich_text_content}</div>
            </div>
        `;
    }
    
    // Add other properties
    Object.values(page.properties).forEach(prop => {
        if (prop.name === 'Description') return; // Already shown above
        
        let value = prop.value;
        if (prop.type === 'date' && typeof value === 'object' && value) {
            value = value.start_date || '';
            if (value.start_time) {
                value += ` ${value.start_time}`;
            }
        } else if (prop.type === 'rich_text') {
            value = prop.rich_text_content || '';
        }
        
        if (value) {
            detailsHtml += `
                <div class="task-detail-item">
                    <div class="task-detail-label">${prop.name}:</div>
                    <div class="task-detail-value">${value}</div>
                </div>
            `;
        }
    });
    
    // Completion toggle
    const isCompleted = completionLogs[page.id]?.find(log => 
        log.date === date && log.completed
    );
    
    detailsHtml += `
        <div class="completion-toggle">
            <label>
                <input type="checkbox" id="taskCompletionToggle" ${isCompleted ? 'checked' : ''}>
                Mark as completed
            </label>
        </div>
    `;
    
    body.innerHTML = detailsHtml;
    
    // Setup completion toggle
    document.getElementById('taskCompletionToggle').addEventListener('change', function(e) {
        markTaskCompleted(page.id, date, e.target.checked);
    });
    
    // Setup open button
    openBtn.onclick = () => openPage(page.id);
    
    // Show modal
    modal.style.display = 'block';
}

function closeTaskModal() {
    document.getElementById('taskModal').style.display = 'none';
    currentTaskModal = null;
}

// Modal event listeners
document.getElementById('taskModalClose').addEventListener('click', closeTaskModal);
document.getElementById('taskModalCloseBtn').addEventListener('click', closeTaskModal);

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    const modal = document.getElementById('taskModal');
    if (event.target === modal) {
        closeTaskModal();
    }
});

// Functions for task completion and page opening
function markTaskCompleted(pageId, date, completed) {
    fetch('/api/mark_completed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ page_id: pageId, date: date, completed: completed })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update completion logs
            if (!completionLogs[pageId]) {
                completionLogs[pageId] = [];
            }
            
            const existingLog = completionLogs[pageId].find(log => log.date === date);
            if (existingLog) {
                existingLog.completed = completed;
            } else {
                completionLogs[pageId].push({ date: date, completed: completed });
            }
            
            // Refresh calendar to show updated status
            calendar.refetchEvents();
        } else {
            console.error('Failed to update task status.');
            // Revert checkbox state
            if (currentTaskModal) {
                document.getElementById('taskCompletionToggle').checked = !completed;
            }
        }
    })
    .catch(error => {
        console.error('Error updating task status:', error);
        // Revert checkbox state
        if (currentTaskModal) {
            document.getElementById('taskCompletionToggle').checked = !completed;
        }
    });
}

function openPage(pageId) {
    window.location.href = `/page/${pageId}`;
}
</script>
{% endblock %}