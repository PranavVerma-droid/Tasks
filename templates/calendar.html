{% extends "base.html" %}

{% block title %}Calendar - Task Manager{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('index') }}">Home</a>
<span class="breadcrumb-separator">/</span>
<span>Calendar</span>
{% endblock %}

{% block top_bar_actions %}
<div class="calendar-nav">
    <button class="btn btn-primary" onclick="goToToday()">Today</button>
    <div class="nav-arrows">
        <button class="btn btn-secondary" onclick="navigate('prev')">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button class="btn btn-secondary" onclick="navigate('next')">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    <h2 id="calendarTitle"></h2>
</div>
<div class="view-switcher btn-group">
    <button id="day-view-btn" class="btn btn-secondary" onclick="switchView('day')">Day</button>
    <button id="week-view-btn" class="btn btn-secondary" onclick="switchView('week')">Week</button>
    <button id="month-view-btn" class="btn btn-secondary active" onclick="switchView('month')">Month</button>
</div>
{% endblock %}

{% block content %}
<div class="calendar-page-container">
    <div class="calendar-sidebar">
        <div class="calendar-sidebar-section">
            <h4>Databases</h4>
            <div id="database-filter-tree">
                <!-- Database filter tree is generated here by JS -->
            </div>
        </div>
    </div>
    <div class="calendar-main">
        <div id="calendar-views">
            <!-- Month View -->
            <div id="month-view" class="view">
                <div class="month-grid-header">
                    <div class="weekday">Sun</div>
                    <div class="weekday">Mon</div>
                    <div class="weekday">Tue</div>
                    <div class="weekday">Wed</div>
                    <div class="weekday">Thu</div>
                    <div class="weekday">Fri</div>
                    <div class="weekday">Sat</div>
                </div>
                <div class="month-grid-body" id="monthGridBody"></div>
            </div>

            <!-- Week View -->
            <div id="week-view" class="view" style="display:none;">
                <div class="time-grid-header">
                    <div class="time-col-gutter"></div>
                </div>
                <div class="time-grid-scroll-container">
                    <div class="time-grid-container">
                        <div class="time-col"></div>
                        <div class="time-grid-body"></div>
                    </div>
                </div>
            </div>

            <!-- Day View -->
            <div id="day-view" class="view" style="display:none;">
                 <div class="time-grid-header">
                    <div class="time-col-gutter"></div>
                </div>
                <div class="time-grid-scroll-container">
                    <div class="time-grid-container">
                        <div class="time-col"></div>
                        <div class="time-grid-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-nav { display: flex; align-items: center; gap: 12px; }
#calendarTitle { font-size: 22px; margin: 0; }
.nav-arrows { display: flex; }
.nav-arrows .btn { border-radius: 0; }
.nav-arrows .btn:first-child { border-top-left-radius: 4px; border-bottom-left-radius: 4px; }
.nav-arrows .btn:last-child { border-top-right-radius: 4px; border-bottom-right-radius: 4px; }

.calendar-page-container { display: flex; height: calc(100vh - 120px); }
.calendar-sidebar { width: 250px; background: #121212; padding: 15px; border-right: 1px solid #333; }
.calendar-main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
#calendar-views { flex-grow: 1; position: relative; }
.view { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; }

/* Month View */
#month-view { display: flex; }
.month-grid-header { display: grid; grid-template-columns: repeat(7, 1fr); background: #1e1e1e; border-bottom: 1px solid #333;}
.month-grid-header .weekday { text-align: center; padding: 10px 0; font-weight: 500; font-size: 13px; color: #aaa; }
.month-grid-body { display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: minmax(120px, 1fr); flex-grow: 1; }
.calendar-day { border-top: 1px solid #333; border-left: 1px solid #333; padding: 8px; position: relative; overflow-y: auto; }
.calendar-day:nth-child(7n+1) { border-left: none; }
.day-number { font-size: 13px; text-align: right; margin-bottom: 4px; }
.calendar-day.not-current-month .day-number { color: #666; }
.calendar-day.today .day-number { background: #4a9eff; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; float: right; }
.day-events { margin-top: 5px; }
.calendar-event { background: #2a2a2a; color: white; padding: 3px 6px; border-radius: 4px; font-size: 12px; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; border-left: 3px solid #4a9eff; }
.calendar-event.completed { text-decoration: line-through; background: #444; border-left-color: #666; }

/* Week/Day View */
.time-grid-header { display: flex; flex-direction: column; border-bottom: 1px solid #333; background: #1e1e1e; }
.date-header-row { display: flex; border-bottom: 1px solid #333; }
.date-header-row .time-col-gutter { width: 60px; flex-shrink: 0; }
.date-header-row .day-header-cell { flex-grow: 1; text-align: center; padding: 8px 0; }
.all-day-strip { display: flex; border-bottom: 1px solid #333; background: #181818; }
.all-day-strip .time-col-gutter { width: 60px; flex-shrink: 0; }
.all-day-day-col { flex-grow: 1; border-left: 1px solid #333; padding: 2px 5px; min-height: 28px; }
.all-day-day-col:first-child { border-left: none; }

.time-grid-scroll-container { flex-grow: 1; overflow-y: scroll; }
.time-grid-container { display: flex; position: relative; }
.time-col { width: 60px; flex-shrink: 0; display: flex; flex-direction: column; text-align: right; font-size: 12px; color: #888; }
.time-col > div { height: 60px; padding-right: 10px; border-top: 1px solid #333; position: relative; top: -8px; }
.time-col > div:first-child { border-top: none; }
.time-grid-body { flex-grow: 1; display: flex; position: relative; background-image: linear-gradient(#333 1px, transparent 1px); background-size: 100% 60px; }
.day-col { flex-grow: 1; border-left: 1px solid #333; position: relative; }
.day-col:first-child { border-left: none; }
.timed-event { position: absolute; left: 5px; right: 5px; background: #4a9eff; color: white; padding: 5px; border-radius: 4px; font-size: 12px; z-index: 1; overflow: hidden; }

/* Task Sidebar Enhancements */
.task-sidebar-section { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333; }
.task-sidebar-section:last-child { border-bottom: none; }
.task-sidebar-section strong { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.task-sidebar-actions .btn { width: 100%; margin-top: 8px; }
.prop-value { padding-left: 22px; color: #ccc; }
.rich-text-preview { padding-left: 22px; }

/* Database Filter Tree */
.calendar-sidebar-section h4 { font-size: 18px; margin-bottom: 10px; color: #fff; }
#database-filter-tree { max-height: 400px; overflow-y: auto; }
.database-filter-item { padding: 8px 0; border-bottom: 1px solid #333; display: flex; align-items: center; }
.database-filter-item label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
.db-color-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
.all-toggle { font-weight: 500; }
.all-toggle label { margin: 0; }
</style>

<script>
let currentDate = new Date();
let currentView = 'month'; // 'month', 'week', 'day'
const calendarItems = {{ calendar_items | tojson }};
const allDatabases = {{ data.databases | tojson }};
const completionLogs = {{ completion_logs | tojson }};
let activeDatabaseIds = Object.keys(allDatabases);

document.addEventListener('DOMContentLoaded', function() {
    buildDatabaseFilterTree();
    renderCalendar();
});

function buildDatabaseFilterTree() {
    const container = document.getElementById('database-filter-tree');
    if (!container) return;
    container.innerHTML = '';

    // Create a "Show/Hide All" checkbox
    const allToggleItem = document.createElement('div');
    allToggleItem.className = 'database-filter-item all-toggle';
    allToggleItem.innerHTML = `
        <label>
            <input type="checkbox" id="all-db-toggle" checked>
            <strong>Show/Hide All</strong>
        </label>
    `;
    container.appendChild(allToggleItem);

    for (const dbId in allDatabases) {
        const db = allDatabases[dbId];
        const item = document.createElement('div');
        item.className = 'database-filter-item';
        item.innerHTML = `
            <label>
                <input type="checkbox" class="db-filter-checkbox" value="${db.id}" checked>
                <span class="db-color-dot" style="background-color: ${db.color};"></span>
                <span>${db.name}</span>
            </label>
        `;
        container.appendChild(item);
    }

    // Add event listeners
    document.getElementById('all-db-toggle').addEventListener('change', function(e) {
        const isChecked = e.target.checked;
        document.querySelectorAll('.db-filter-checkbox').forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        updateActiveDatabasesAndRender();
    });

    document.querySelectorAll('.db-filter-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateActiveDatabasesAndRender);
    });
}

function updateActiveDatabasesAndRender() {
    activeDatabaseIds = Array.from(document.querySelectorAll('.db-filter-checkbox:checked')).map(cb => cb.value);
    
    const allCheckboxes = document.querySelectorAll('.db-filter-checkbox');
    const allToggle = document.getElementById('all-db-toggle');
    if (activeDatabaseIds.length === allCheckboxes.length) {
        allToggle.checked = true;
        allToggle.indeterminate = false;
    } else if (activeDatabaseIds.length === 0) {
        allToggle.checked = false;
        allToggle.indeterminate = false;
    } else {
        allToggle.indeterminate = true;
    }

    renderCalendar();
}

function switchView(view) {
    currentView = view;
    document.querySelectorAll('.view-switcher .btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`${view}-view-btn`).classList.add('active');
    
    document.querySelectorAll('#calendar-views .view').forEach(v => v.style.display = 'none');
    document.getElementById(`${view}-view`).style.display = 'flex';
    
    renderCalendar();
}

function navigate(direction) {
    const d = direction === 'next' ? 1 : -1;
    if (currentView === 'month') {
        currentDate.setMonth(currentDate.getMonth() + d, 1);
    } else if (currentView === 'week') {
        currentDate.setDate(currentDate.getDate() + (d * 7));
    } else if (currentView === 'day') {
        currentDate.setDate(currentDate.getDate() + d);
    }
    renderCalendar();
}

function goToToday() {
    currentDate = new Date();
    renderCalendar();
}

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function renderCalendar() {
    if (currentView === 'month') {
        renderMonthView();
    } else if (currentView === 'week') {
        renderWeekView();
    } else if (currentView === 'day') {
        renderDayView();
    }
}

function renderMonthView() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    document.getElementById('calendarTitle').textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

    const gridBody = document.getElementById('monthGridBody');
    gridBody.innerHTML = '';
    
    const firstDayOfMonth = new Date(year, month, 1);
    
    const startDate = new Date(firstDayOfMonth);
    startDate.setDate(startDate.getDate() - firstDayOfMonth.getDay());

    // Ensure we always render 6 weeks for a consistent layout
    const numDaysToRender = 42; 

    for (let i = 0; i < numDaysToRender; i++) {
        const day = new Date(startDate);
        day.setDate(startDate.getDate() + i);
        
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        if (day.getMonth() !== month) dayEl.classList.add('not-current-month');
        if (formatDate(day) === formatDate(new Date())) dayEl.classList.add('today');
        
        dayEl.innerHTML = `<div class="day-number">${day.getDate()}</div><div class="day-events"></div>`;
        
        const eventsContainer = dayEl.querySelector('.day-events');
        const dateString = formatDate(day);
        const dayEvents = calendarItems.filter(item => item.date === dateString && activeDatabaseIds.includes(item.page.parent_database_id));
        
        dayEvents.forEach(event => {
            const eventEl = document.createElement('div');
            eventEl.className = 'calendar-event';
            if (completionLogs[event.page.id]?.find(log => log.date === dateString && log.completed)) {
                eventEl.classList.add('completed');
            }
            eventEl.textContent = event.page.title;
            eventEl.style.borderLeftColor = event.database_color;
            eventEl.onclick = () => showTaskDetails(event.page, event.date);
            eventsContainer.appendChild(eventEl);
        });
        
        gridBody.appendChild(dayEl);
    }
}

function renderTimeGrid(numDays) {
    const view = currentView === 'day' ? 'day-view' : 'week-view';
    const headerContainer = document.querySelector(`#${view} .time-grid-header`);
    const timeCol = document.querySelector(`#${view} .time-col`);
    const body = document.querySelector(`#${view} .time-grid-body`);
    
    headerContainer.innerHTML = '';
    timeCol.innerHTML = '';
    body.innerHTML = '';

    // --- Render date headers row ---
    const dateHeaderRow = document.createElement('div');
    dateHeaderRow.className = 'date-header-row';
    dateHeaderRow.style.display = 'flex';
    dateHeaderRow.appendChild(Object.assign(document.createElement('div'), {className: 'time-col-gutter'}));
    for (let i = 0; i < numDays; i++) {
        const start = new Date(currentDate);
        if (numDays === 7) {
            start.setDate(start.getDate() - start.getDay());
        }
        const date = new Date(start);
        date.setDate(start.getDate() + i);
        const headerCell = document.createElement('div');
        headerCell.className = 'day-header-cell';
        headerCell.innerHTML = `<div class="day-name">${date.toLocaleString('default', { weekday: 'short' })}</div><div class="day-date">${date.getDate()}</div>`;
        if (formatDate(date) === formatDate(new Date())) headerCell.classList.add('today');
        dateHeaderRow.appendChild(headerCell);
    }
    headerContainer.appendChild(dateHeaderRow);

    // --- Render all-day strip row ---
    const allDayStrip = document.createElement('div');
    allDayStrip.className = 'all-day-strip';
    allDayStrip.style.display = 'flex';
    allDayStrip.appendChild(Object.assign(document.createElement('div'), {className: 'time-col-gutter', innerHTML: '<span style="font-size:11px; color: #888; padding-left: 5px;">all-day</span>'}));
    for (let i = 0; i < numDays; i++) {
        const start = new Date(currentDate);
        if (numDays === 7) {
            start.setDate(start.getDate() - start.getDay());
        }
        const date = new Date(start);
        date.setDate(start.getDate() + i);
        const allDayCol = document.createElement('div');
        allDayCol.className = 'all-day-day-col';
        allDayCol.dataset.date = formatDate(date);
        allDayStrip.appendChild(allDayCol);
    }
    headerContainer.appendChild(allDayStrip);

    // --- Render time labels ---
    for (let i = 0; i < 24; i++) {
        const timeLabel = document.createElement('div');
        if (i > 0) {
            timeLabel.textContent = `${i > 12 ? i - 12 : i} ${i < 12 || i === 24 ? 'AM' : 'PM'}`;
        }
        timeCol.appendChild(timeLabel);
    }
    
    // --- Render day columns ---
    for (let i = 0; i < numDays; i++) {
        const start = new Date(currentDate);
        if (numDays === 7) {
            start.setDate(start.getDate() - start.getDay());
        }
        const date = new Date(start);
        date.setDate(start.getDate() + i);
        const dayCol = document.createElement('div');
        dayCol.className = 'day-col';
        dayCol.dataset.date = formatDate(date);
        body.appendChild(dayCol);
    }

    placeEventsInTimeGrid(numDays === 7 ? (() => { let s = new Date(currentDate); s.setDate(s.getDate() - s.getDay()); return s; })() : new Date(currentDate), numDays);
}


function renderWeekView() {
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    document.getElementById('calendarTitle').textContent = `${startOfWeek.toLocaleString('default', {month: 'long', day: 'numeric'})} - ${endOfWeek.toLocaleString('default', {month: 'long', day: 'numeric', year: 'numeric'})}`;
    renderTimeGrid(7);
}

function renderDayView() {
    document.getElementById('calendarTitle').textContent = currentDate.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    renderTimeGrid(1);
}

function placeEventsInTimeGrid(viewStartDate, numDays) {
    const viewEndDate = new Date(viewStartDate);
    viewEndDate.setDate(viewStartDate.getDate() + numDays);

    const eventsInView = calendarItems.filter(item => {
        const itemDate = new Date(item.date + 'T00:00:00'); // Ensure we compare dates correctly
        return itemDate >= viewStartDate && itemDate < viewEndDate && activeDatabaseIds.includes(item.page.parent_database_id);
    });

    eventsInView.forEach(event => {
        const dateString = event.date;
        const eventEl = document.createElement('div');
        eventEl.className = 'calendar-event';
        if (completionLogs[event.page.id]?.find(log => log.date === dateString && log.completed)) {
            eventEl.classList.add('completed');
        }
        eventEl.textContent = event.page.title;
        eventEl.onclick = () => showTaskDetails(event.page, event.date);

        if (event.is_all_day) {
            const allDayCol = document.querySelector(`.all-day-day-col[data-date="${dateString}"]`);
            if (allDayCol) allDayCol.appendChild(eventEl);
        } else {
            const dayCol = document.querySelector(`.day-col[data-date="${dateString}"]`);
            if (!dayCol) return;

            const [startHour, startMinute] = event.start_time.split(':').map(Number);
            const end = event.end_time ? event.end_time.split(':').map(Number) : [startHour + 1, startMinute];
            const [endHour, endMinute] = end;

            const startTotalMinutes = startHour * 60 + startMinute;
            const endTotalMinutes = endHour * 60 + endMinute;

            const top = (startTotalMinutes / 60) * 60; // top in pixels, assuming 60px per hour
            const height = ((endTotalMinutes - startTotalMinutes) / 60) * 60;
            
            const timedEventEl = document.createElement('div');
            timedEventEl.className = 'timed-event';
            if (completionLogs[event.page.id]?.find(log => log.date === dateString && log.completed)) {
                timedEventEl.classList.add('completed');
            }
            timedEventEl.style.top = `${top}px`;
            timedEventEl.style.height = `${Math.max(20, height)}px`; // min height
            timedEventEl.textContent = event.page.title;
            timedEventEl.onclick = () => showTaskDetails(event.page, event.date);
            
            dayCol.appendChild(timedEventEl);
        }
    });
}

function showTaskDetails(page, date) {
    const sidebar = document.getElementById('taskSidebar');
    const sidebarContent = document.getElementById('taskSidebarContent');

    // --- Location Breadcrumb (Full Hierarchy, including DB's parent page) ---
    let breadcrumbParts = [];
    breadcrumbParts.push(`<a href=\"/\"><i class=\"fas fa-home\"></i> Home</a>`);

    // First, build the full parent chain for the page
    let parentChain = [];
    let current = page;
    while (current && (current.parent_page || current.parent_database_id)) {
        if (current.parent_page) {
            parentChain.push({
                type: 'page',
                id: current.parent_page.id,
                title: current.parent_page.title
            });
            current = current.parent_page;
        } else if (current.parent_database_id && allDatabases[current.parent_database_id]) {
            const db = allDatabases[current.parent_database_id];
            // Traverse up the database's parent_page chain if it exists
            let dbParentChain = [];
            let dbCurrent = db;
            while (dbCurrent && dbCurrent.parent_page) {
                dbParentChain.push({
                    type: 'page',
                    id: dbCurrent.parent_page.id,
                    title: dbCurrent.parent_page.title
                });
                dbCurrent = dbCurrent.parent_page;
            }
            dbParentChain = dbParentChain.reverse();
            parentChain = parentChain.concat(dbParentChain);
            // Add the database itself
            parentChain.push({
                type: 'database',
                id: db.id,
                title: db.name,
                color: db.color
            });
            break;
        } else {
            break;
        }
    }
    parentChain = parentChain.reverse();
    parentChain.forEach(item => {
        breadcrumbParts.push('<span class="breadcrumb-separator">/</span>');
        if (item.type === 'database') {
            breadcrumbParts.push(`<a href=\"/database/${item.id}\"><span style=\"color:${item.color};font-weight:500;\">${item.title}</span></a>`);
        } else {
            breadcrumbParts.push(`<a href=\"/page/${item.id}\">${item.title}</a>`);
        }
    });
    // Current task (not a link)
    breadcrumbParts.push('<span class="breadcrumb-separator">/</span>');
    breadcrumbParts.push(`<span style=\"font-weight:600; color:#fff;\">${page.title}</span>`);
    let locationBreadcrumb = `<div class=\"breadcrumb\" style=\"margin-bottom:8px; font-size:13px; color:#9ca3af;\">${breadcrumbParts.join(' ')}</div>`;

    document.getElementById('taskSidebarTitle').textContent = page.title;

    // --- Time Information ---
    const dateProp = Object.values(page.properties).find(p => p.type === 'date');
    let timeString = 'All-day';
    if (dateProp && dateProp.value && dateProp.value.start_time) {
        timeString = formatTime(dateProp.value.start_time);
        if (dateProp.value.end_time) {
            timeString += ` - ${formatTime(dateProp.value.end_time)}`;
        }
    }

    // --- Completion Status ---
    const isCompleted = completionLogs[page.id]?.some(log => log.date === date && log.completed);
    const completeButtonText = isCompleted ? 'Mark as Incomplete' : 'Mark as Completed';
    const completeButtonClass = isCompleted ? 'btn-success' : 'btn-secondary';

    // --- Other Properties (like Location) ---
    let propertiesHtml = '';
    for (const propId in page.properties) {
        const prop = page.properties[propId];
        if (prop.type !== 'date' && prop.name.toLowerCase() !== 'description' && (prop.value || prop.rich_text_content)) {
            let icon = 'fa-info-circle';
            if (prop.name.toLowerCase().includes('location')) {
                icon = 'fa-map-marker-alt';
            }
            const propValue = prop.type === 'rich_text' ? (prop.rich_text_content || '') : (prop.value || '');
            propertiesHtml += `
                <div class="task-sidebar-section">
                    <strong><i class="fas ${icon}"></i> ${prop.name}</strong>
                    <div class="prop-value">${propValue}</div>
                </div>
            `;
        }
    }

    // --- Description ---
    const description = page.properties.description ? page.properties.description.rich_text_content : '<p><em>No description.</em></p>';

    // --- Build Sidebar HTML ---
    sidebarContent.innerHTML = `
        ${locationBreadcrumb}
        <div class="task-sidebar-section">
            <p><strong><i class="fas fa-calendar-alt"></i> Date:</strong> ${date}</p>
            <p><strong><i class="fas fa-clock"></i> Time:</strong> ${timeString}</p>
        </div>
        ${propertiesHtml}
        <div class="task-sidebar-section">
            <strong><i class="fas fa-align-left"></i> Description</strong>
            <div class="rich-text-preview">${description}</div>
        </div>
        <div class="task-sidebar-actions">
             <button class="btn btn-block ${completeButtonClass}" onclick="markTaskCompleted('${page.id}', '${date}', ${!isCompleted})">
                <i class="fas fa-check-circle"></i> ${completeButtonText}
             </button>
        </div>
        <div class="task-sidebar-actions">
            <button class="btn btn-block btn-primary" onclick="openPage('${page.id}')"><i class="fas fa-external-link-alt"></i> Open as Page</button>
            <button class="btn btn-block btn-secondary" onclick="editPage('${page.id}')"><i class="fas fa-edit"></i> Edit Task</button>
        </div>
    `;
    sidebar.classList.add('active');
}

function markTaskCompleted(pageId, date, completed) {
    fetch('/api/mark_completed', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            page_id: pageId,
            date: date,
            completed: completed
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Simple reload to show changes
        } else {
            alert('Failed to update task status.');
        }
    });
}

function formatTime(time) {
    if (!time) return '';
    let [h, m] = time.split(':');
    const ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    return `${h}:${m} ${ampm}`;
}

function openPage(pageId) {
    window.location.href = `/page/${pageId}`;
}
</script>
{% endblock %}
