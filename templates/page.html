{% extends "base.html" %}

{% block title %}{{ page.title }} - Notion Alternative{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('index') }}">Home</a>
{% if hierarchy %}
{% for item in hierarchy %}
<span class="breadcrumb-separator">/</span>
{% if item.type == 'page' %}
<a href="{{ url_for('navigate_to_page', page_id=item.id) }}">{{ item.title }}</a>
{% else %}
<a href="{{ url_for('navigate_to_database', database_id=item.id) }}">{{ item.title }}</a>
{% endif %}
{% endfor %}
{% else %}
<span class="breadcrumb-separator">/</span>
<span>{{ page.title }}</span>
{% endif %}
{% endblock %}

{% block top_bar_actions %}
<button class="btn btn-secondary" onclick="addDatabase()">
    <i class="fas fa-database"></i>
    Add Database
</button>
<button class="btn btn-primary" onclick="savePage()">
    <i class="fas fa-save"></i>
    Save
</button>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div class="page-title-container">
            <h1 class="page-title" id="pageTitle" contenteditable="true">{{ page.title }}</h1>
        </div>
        <div class="page-actions">
            <button class="btn btn-primary" onclick="savePage()">
                <i class="fas fa-save"></i> Save Page
            </button>
            <button class="btn btn-secondary" onclick="window.history.back()">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>
    </div>
    
    <div class="page-content">
        <!-- Editable Page Description Section -->
        <div id="pageDescriptionContainer">
            <div class="description-toggle-container">
                <div class="description-toggle-header" onclick="toggleDescription('pageDescriptionContainer')">
                    <i class="fas fa-chevron-down toggle-icon"></i>
                    <span class="toggle-text">Description</span>
                    <span class="toggle-indicator">
                        {% if 'description' in page.properties and page.properties.description.rich_text_content|default('', true)|length > 0 %}
                            Has content
                        {% else %}
                            Empty
                        {% endif %}
                    </span>
                </div>
                <div class="description-content expanded" id="pageDescriptionContainer_content">
                    <textarea id="pageDescriptionContainer_editor" data-rich-text="true" data-placeholder="Enter a detailed description...">{% if 'description' in page.properties %}{{ page.properties.description.rich_text_content|safe }}{% else %}{% endif %}</textarea>
                </div>
            </div>
        </div>
        
        <!-- Existing databases -->
        {% for database in databases %}
        <div class="database-container" data-database-id="{{ database.id }}">
            <div class="database-header">
                <h3 class="database-title">{{ database.name }}</h3>
                <div class="database-actions">
                    <button class="btn btn-sm btn-secondary" onclick="addPageToDatabase('{{ database.id }}')">
                        <i class="fas fa-plus"></i>
                        Add Page
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="editDatabase('{{ database.id }}')">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            <div class="database-table">
                <div class="database-table-header" style="display: grid; grid-template-columns: 300px 200px{% for prop in database.properties %} 1fr{% endfor %} 100px;">
                    <div class="table-cell table-cell-title">Title</div>
                    <div class="table-cell">Description</div>
                    {% for prop_id, prop in database.properties.items() %}
                    <div class="table-cell">{{ prop.name }}</div>
                    {% endfor %}
                    <div class="table-cell table-cell-actions">Actions</div>
                </div>
                <div class="database-table-body" id="databaseBody_{{ database.id }}">
                    {% for page_id in database.pages %}
                    {% set page = data.pages[page_id] %}
                    <div class="database-table-row" style="display: grid; grid-template-columns: 300px 200px{% for prop in database.properties %} 1fr{% endfor %} 100px;" data-page-id="{{ page.id }}">
                        <div class="table-cell table-cell-title">
                            <div class="page-title-container">
                                <div class="page-title-editable" contenteditable="true" onblur="updatePageTitle('{{ page.id }}', this.textContent)">
                                    {{ page.title }}
                                </div>
                                {% if page.databases and page.databases|length > 0 %}
                                <i class="fas fa-folder-tree nested-indicator" title="Has nested databases"></i>
                                {% endif %}
                            </div>
                        </div>
                        <div class="table-cell">
                            {% set description = page.properties.description.rich_text_content if page.properties.description and page.properties.description.rich_text_content else page.properties.description.value if page.properties.description and page.properties.description.value else '' %}
                            {% if description %}
                                <span class="description-cell">{{ description|truncate(50, True, '...') }}</span>
                            {% else %}
                                <span class="empty-property">Empty</span>
                            {% endif %}
                        </div>
                        {% for prop_id, prop in database.properties.items() %}
                        <div class="table-cell">
                            {% set pageProp = page.properties[prop_id] %}
                            {% if pageProp %}
                                {{ render_property_value(pageProp, prop) | safe if render_property_value is defined else pageProp.value }}
                            {% else %}
                                <span class="empty-property">-</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                        <div class="table-cell table-cell-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editPage('{{ page.id }}')" title="Edit page">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-info" onclick="viewPageDetails('{{ page.id }}')" title="View details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="openPage('{{ page.id }}')" title="Open page">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deletePage('{{ page.id }}')" title="Delete page">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
        
        <!-- Empty state -->
        {% if not databases %}
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-database"></i>
            </div>
            <h3>No databases yet</h3>
            <p>Create your first database to start organizing your content.</p>
            <button class="btn btn-primary" onclick="addDatabase()">
                <i class="fas fa-plus"></i>
                Create Database
            </button>
        </div>
        {% endif %}
    </div>
</div>

<script>
const currentPageId = '{{ page.id }}';
const pageDescriptionData = {% if page.properties.description and page.properties.description.rich_text_content %}{{ page.properties.description.rich_text_content | tojson }}{% else %}""{% endif %};

// Make currentPageId globally accessible for auto-save
window.currentPageId = currentPageId;

function ensureDescriptionProperty() {
    if (!window.currentPageId) return;
    
    // Check if description property exists
    fetch(`/api/get_page_data/${window.currentPageId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const page = data.page;
                if (!page.properties.description) {
                    // Create the description property
                    fetch('/api/update_page', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            page_id: window.currentPageId,
                            updates: {
                                properties: {
                                    description: {
                                        name: 'Description',
                                        type: 'rich_text',
                                        value: '',
                                        rich_text_content: ''
                                    }
                                }
                            }
                        })
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (!result.success) {
                            console.error('Failed to create description property:', result);
                        }
                    })
                    .catch(error => {
                        console.error('Error creating description property:', error);
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error checking page data:', error);
        });
}

// Load database data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadAllDatabases();
    ensureDescriptionProperty();
    
    // Initialize auto-save for form inputs
    document.addEventListener('DOMContentLoaded', function() {
        // Add auto-save to all form inputs
        const inputs = document.querySelectorAll('input[type="text"], input[type="number"], textarea, select');
        inputs.forEach(input => {
            if (!input.classList.contains('ckeditor')) {
                input.addEventListener('input', function() {
                    autoSaveFormInput(this);
                });
            }
        });
    });
});

function loadPageDescription() {
    // Check if the description editor already exists in the DOM
    const existingEditor = document.getElementById('pageDescriptionContainer_editor');
    if (existingEditor && !existingEditor.classList.contains('rich-text-initialized')) {
        // Handle the content properly - it might be a string or already parsed
        let content = '';
        if (pageDescriptionData) {
            if (typeof pageDescriptionData === 'string') {
                content = pageDescriptionData;
            } else {
                content = pageDescriptionData.toString();
            }
        }
        
        // Set the textarea value if there's content
        if (content) {
            existingEditor.value = content;
        }
        
        // Initialize rich text editor only once
        setTimeout(() => {
            initRichTextEditor('#pageDescriptionContainer_editor', 'Enter a detailed description...');
            if (content) {
                setRichTextContent('#pageDescriptionContainer_editor', content);
            }
        }, 100);
    }
}

function toggleDescription(containerId) {
    const container = document.getElementById(containerId);
    const content = container.querySelector('.description-content');
    const header = container.querySelector('.description-toggle-header');
    const icon = header.querySelector('.toggle-icon');
    const text = header.querySelector('.toggle-text');
    
    const isExpanded = content.classList.contains('expanded');
    
    if (isExpanded) {
        content.classList.remove('expanded');
        icon.className = 'fas fa-chevron-down toggle-icon';
    } else {
        content.classList.add('expanded');
        icon.className = 'fas fa-chevron-up toggle-icon';
    }
}

function loadAllDatabases() {
    const databases = {{ databases | tojson }};
    databases.forEach(database => {
        loadDatabaseData(database.id);
    });
}

function loadDatabaseData(databaseId) {
    fetch(`/api/get_database_data/${databaseId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderDatabaseTable(databaseId, data.pages, data.database);
            }
        })
        .catch(error => {
            console.error('Error loading database data:', error);
        });
}

function renderDatabaseTable(databaseId, pages, database) {
    const tableBody = document.getElementById(`databaseBody_${databaseId}`);
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    pages.forEach(page => {
        const row = document.createElement('div');
        row.className = 'database-table-row';
        row.setAttribute('data-page-id', page.id);
        
        // Title cell with description
        const titleCell = document.createElement('div');
        titleCell.className = 'table-cell table-cell-title';
        
        const description = page.properties.description ? page.properties.description.rich_text_content || page.properties.description.value : '';
        let descriptionHtml = '';
        
        if (description) {
            const isLongDescription = description.length > 50;
            const displayText = isLongDescription ? description.substring(0, 50) + '...' : description;
            const className = isLongDescription ? 'page-description has-full-text' : 'page-description';
            const dataAttr = isLongDescription ? `data-full-text="${description.replace(/"/g, '&quot;')}"` : '';
            
            descriptionHtml = `<div class="${className}" ${dataAttr}>${displayText}</div>`;
        }
        
        // Check if page has nested databases
        const hasNestedDatabases = page.databases && page.databases.length > 0;
        const nestedIndicator = hasNestedDatabases ? '<i class="fas fa-folder-tree nested-indicator" title="Has nested databases"></i>' : '';
        
        titleCell.innerHTML = `
            <div class="page-title-container">
                <div class="page-title-editable" contenteditable="true" onblur="updatePageTitle('${page.id}', this.textContent)">
                    ${page.title}
                </div>
                ${nestedIndicator}
            </div>
            ${descriptionHtml}
        `;
        
        // Make the entire row clickable to show details
        row.style.cursor = 'pointer';
        row.onclick = (e) => {
            // Don't trigger if clicking on action buttons
            if (!e.target.closest('.table-cell-actions')) {
                viewPageDetails(page.id);
            }
        };
        
        row.appendChild(titleCell);
        
        // Property cells
        Object.values(database.properties).forEach(prop => {
            const cell = document.createElement('div');
            cell.className = 'table-cell';
            
            const pageProp = page.properties[prop.id];
            if (pageProp) {
                cell.innerHTML = renderPropertyValue(pageProp, prop);
            } else {
                cell.innerHTML = '<span class="empty-property">-</span>';
            }
            
            row.appendChild(cell);
        });
        
        // Actions cell
        const actionsCell = document.createElement('div');
        actionsCell.className = 'table-cell table-cell-actions';
        actionsCell.innerHTML = `
            <button class="btn btn-sm btn-secondary" onclick="editPage('${page.id}')" title="Edit page">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-info" onclick="viewPageDetails('${page.id}')" title="View details">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-primary" onclick="openPage('${page.id}')" title="Open page">
                <i class="fas fa-external-link-alt"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deletePage('${page.id}')" title="Delete page">
                <i class="fas fa-trash"></i>
            </button>
        `;
        row.appendChild(actionsCell);
        
        tableBody.appendChild(row);
    });
}

function renderPropertyValue(pageProp, propDef) {
    switch (propDef.type) {
        case 'text':
            return `<span>${pageProp.value || ''}</span>`;
        case 'rich_text':
            const richContent = pageProp.rich_text_content || pageProp.value || '';
            if (richContent) {
                return `<div class="rich-text-preview">${richContent}</div>`;
            }
            return `<span class="empty-property">-</span>`;
        case 'date':
            if (pageProp.value && typeof pageProp.value === 'object') {
                const dateValue = pageProp.value.start_date || pageProp.value.end_date || '';
                return `<span>${dateValue}</span>`;
            }
            return `<span>${pageProp.value || ''}</span>`;
        case 'select':
        case 'status':
            return `<span class="property-tag">${pageProp.value || ''}</span>`;
        case 'number':
            return `<span>${pageProp.value || ''}</span>`;
        default:
            return `<span>${pageProp.value || ''}</span>`;
    }
}

function addDatabase() {
    // Create modal content
    const modalContent = `
        <div class="form-group">
            <label for="modalDatabaseName">Database Name</label>
            <input type="text" id="modalDatabaseName" class="form-control" placeholder="Enter database name">
        </div>
        <div class="form-group">
            <label>Properties</label>
            <div id="modalPropertiesList">
                <div class="property-item">
                    <input type="text" class="form-control property-name" placeholder="Property name">
                    <select class="form-control property-type">
                        <option value="text">Text</option>
                        <option value="rich_text">Rich Text</option>
                        <option value="date">Date</option>
                        <option value="select">Select</option>
                        <option value="status">Status</option>
                        <option value="number">Number</option>
                    </select>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeProperty(this)">Remove</button>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-secondary" onclick="addProperty()">Add Property</button>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="confirmCreateDatabase()">Create Database</button>
        </div>
    `;
    
    // Show modal
    document.getElementById('modalTitle').textContent = 'Create Database';
    document.getElementById('modalContent').innerHTML = modalContent;
    document.getElementById('modalOverlay').classList.add('active');
}

function confirmCreateDatabase() {
    const nameElement = document.getElementById('modalDatabaseName');
    if (!nameElement) {
        console.error('Database name element not found');
        return;
    }
    
    const name = nameElement.value;
    if (!name || !name.trim()) {
        alert('Please enter a database name');
        return;
    }
    
    const properties = {};
    document.querySelectorAll('.property-item').forEach((item, index) => {
        const propName = item.querySelector('.property-name').value;
        const propType = item.querySelector('.property-type').value;
        
        if (propName) {
            const propId = `prop_${index}`;
            properties[propId] = {
                name: propName,
                type: propType,
                options: propType === 'select' || propType === 'status' ? ['Not Started', 'In Progress', 'Done'] : []
            };
        }
    });
    
    createDatabase(name, properties);
    closeModal();
}

function createDatabase(name, properties) {
    fetch('/api/create_database', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            page_id: currentPageId,
            name: name,
            properties: properties
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error creating database:', error);
    });
}

function addPageToDatabase(databaseId) {
    // Get database data to show all properties
    fetch(`/api/get_database_data/${databaseId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const database = data.database;
                showAddPageModal(databaseId, database);
            }
        })
        .catch(error => {
            console.error('Error loading database data:', error);
        });
}

function showAddPageModal(databaseId, database) {
    let propertiesHtml = '';
    let datePropIndex = null;
    let dateProp = null;
    
    // Find the date property (if any)
    Object.values(database.properties).forEach((prop, index) => {
        if (prop.type === 'date' && datePropIndex === null) {
            datePropIndex = index;
            dateProp = prop;
        }
    });
    
    // Build property inputs, skipping the date property (handled separately)
    Object.values(database.properties).forEach((prop, index) => {
        if (index === datePropIndex) return;
        propertiesHtml += `
            <div class="form-group">
                <label for="modalProp_${index}">${prop.name}</label>
                ${renderPropertyInput(prop, index)}
            </div>
        `;
    });

    // Date and repetition UI
    let dateRepetitionHtml = '';
    if (dateProp) {
        dateRepetitionHtml = `
            <div class="form-group">
                <label for="modalDate">${dateProp.name}</label>
                <input type="date" id="modalDate" class="form-control">
                <div style="margin-top:8px;">
                    <label><input type="checkbox" id="repetitionCheckbox" onchange="toggleRepetitionOptions()"> Repetition</label>
                </div>
            </div>
            <div id="repetitionOptions" style="display:none; margin-bottom: 12px;">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="repetitionStartDate" class="form-control">
                </div>
                <div class="form-group">
                    <label>End Date (Optional)</label>
                    <input type="date" id="repetitionEndDate" class="form-control">
                </div>
                <div class="form-group">
                    <label>Frequency</label>
                    <select id="repetitionType" class="form-control" onchange="updateRepetitionOptions()">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                
                <!-- Daily options -->
                <div class="form-group" id="dailyOptions" style="display:none">
                    <label>Every</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="number" id="dailyInterval" class="form-control" min="1" value="1" style="width: 80px;">
                        <span>day(s)</span>
                    </div>
                </div>
                
                <!-- Weekly options -->
                <div id="weeklyOptions" style="display:none">
                    <div class="form-group">
                        <label>Every</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" id="weeklyInterval" class="form-control" min="1" value="1" style="width: 80px;">
                            <span>week(s) on:</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <div id="weeklyDaysCheckboxes" style="display: flex; flex-wrap: wrap; gap: 12px;">
                            <label><input type="checkbox" value="0"> Sun</label>
                            <label><input type="checkbox" value="1"> Mon</label>
                            <label><input type="checkbox" value="2"> Tue</label>
                            <label><input type="checkbox" value="3"> Wed</label>
                            <label><input type="checkbox" value="4"> Thu</label>
                            <label><input type="checkbox" value="5"> Fri</label>
                            <label><input type="checkbox" value="6"> Sat</label>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly options -->
                <div id="monthlyOptions" style="display:none">
                    <div class="form-group">
                        <label>Every</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" id="monthlyInterval" class="form-control" min="1" value="1" style="width: 80px;">
                            <span>month(s) on day</span>
                            <input type="number" id="monthlyDay" class="form-control" min="1" max="31" value="1" style="width: 80px;">
                        </div>
                    </div>
                </div>
                
                <!-- Custom options -->
                <div id="customOptions" style="display:none">
                    <div class="form-group">
                        <label>Every</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" id="customInterval" class="form-control" min="1" value="2" style="width: 80px;">
                            <span>week(s) on:</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <div id="customDaysCheckboxes" style="display: flex; flex-wrap: wrap; gap: 12px;">
                            <label><input type="checkbox" value="0"> Sun</label>
                            <label><input type="checkbox" value="1"> Mon</label>
                            <label><input type="checkbox" value="2"> Tue</label>
                            <label><input type="checkbox" value="3"> Wed</label>
                            <label><input type="checkbox" value="4"> Thu</label>
                            <label><input type="checkbox" value="5"> Fri</label>
                            <label><input type="checkbox" value="6"> Sat</label>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    const modalContent = `
        <div class="form-group">
            <label for="modalPageTitle">Page Title</label>
            <input type="text" id="modalPageTitle" class="form-control" placeholder="Enter page title">
        </div>
        <div class="form-group">
            <label for="modalPageDescription">Description</label>
            <textarea id="modalPageDescription" data-rich-text="true" data-placeholder="Enter description..."></textarea>
        </div>
        ${dateRepetitionHtml}
        ${propertiesHtml}
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="confirmCreatePage('${databaseId}')">Create Page</button>
        </div>
    `;
    document.getElementById('modalTitle').textContent = 'Add Page';
    document.getElementById('modalContent').innerHTML = modalContent;
    document.getElementById('modalOverlay').classList.add('active');
    setTimeout(() => {
        initRichTextEditorForModal();
        updateRepetitionOptions(); // Initialize the display
    }, 200);
}

function toggleRepetitionOptions() {
    const checkbox = document.getElementById('repetitionCheckbox');
    const options = document.getElementById('repetitionOptions');
    const singleDate = document.getElementById('modalDate');
    
    if (checkbox && checkbox.checked) {
        options.style.display = '';
        if (singleDate) singleDate.style.display = 'none';
        updateRepetitionOptions();
    } else {
        options.style.display = 'none';
        if (singleDate) singleDate.style.display = '';
    }
}

function updateRepetitionOptions() {
    const type = document.getElementById('repetitionType').value;
    
    // Hide all option groups
    const optionGroups = ['dailyOptions', 'weeklyOptions', 'monthlyOptions', 'customOptions'];
    optionGroups.forEach(groupId => {
        const group = document.getElementById(groupId);
        if (group) group.style.display = 'none';
    });
    
    // Show relevant option group
    const targetGroup = document.getElementById(type + 'Options');
    if (targetGroup) {
        targetGroup.style.display = '';
    }
}

function confirmCreatePage(databaseId) {
    const titleElement = document.getElementById('modalPageTitle');
    const descriptionElement = document.getElementById('modalPageDescription');
    
    if (!titleElement) {
        console.error('Page title element not found');
        return;
    }
    
    const title = titleElement.value;
    if (!title || !title.trim()) {
        alert('Please enter a page title');
        return;
    }

    // Get database to know what properties to collect
    fetch(`/api/get_database_data/${databaseId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const database = data.database;
                const properties = {};
                
                let datePropIndex = null;
                let datePropId = null;
                
                // Find date property
                Object.values(database.properties).forEach((prop, index) => {
                    if (prop.type === 'date' && datePropIndex === null) {
                        datePropIndex = index;
                        datePropId = prop.id;
                    }
                });
                
                // Collect all property values except date
                Object.values(database.properties).forEach((prop, index) => {
                    if (index === datePropIndex) return; // Skip date property
                    
                    const inputElement = document.getElementById(`modalProp_${index}`);
                    if (inputElement) {
                        let value = '';
                        if (prop.type === 'rich_text') {
                            value = getRichTextContent(`modalProp_${index}`);
                        } else {
                            value = inputElement.value;
                        }
                        
                        if (value) {
                            properties[prop.id] = {
                                name: prop.name,
                                type: prop.type,
                                value: prop.type === 'rich_text' ? '' : value,
                                rich_text_content: prop.type === 'rich_text' ? value : null
                            };
                        }
                    }
                });
                
                // Handle date/repetition
                if (datePropId !== null) {
                    const repetitionChecked = document.getElementById('repetitionCheckbox') && document.getElementById('repetitionCheckbox').checked;
                    
                    if (!repetitionChecked) {
                        // Single date
                        const dateValue = document.getElementById('modalDate').value;
                        if (dateValue) {
                            properties[datePropId] = {
                                name: database.properties[datePropId].name,
                                type: 'date',
                                value: dateValue
                            };
                        }
                    } else {
                        // Repetition
                        const repetitionType = document.getElementById('repetitionType').value;
                        const startDate = document.getElementById('repetitionStartDate').value;
                        const endDate = document.getElementById('repetitionEndDate').value;
                        
                        if (!startDate) {
                            alert('Please select a start date for repetition');
                            return;
                        }
                        
                        const repetitionConfig = {
                            start_date: startDate,
                            repetition: true,
                            repetition_type: repetitionType,
                            repetition_config: {
                                end_date: endDate || null
                            }
                        };
                        
                        // Add type-specific configuration
                        if (repetitionType === 'daily') {
                            const interval = parseInt(document.getElementById('dailyInterval').value) || 1;
                            repetitionConfig.repetition_config.interval = interval;
                        } else if (repetitionType === 'weekly') {
                            const interval = parseInt(document.getElementById('weeklyInterval').value) || 1;
                            const daysChecked = Array.from(document.querySelectorAll('#weeklyDaysCheckboxes input[type=checkbox]:checked'))
                                .map(cb => parseInt(cb.value));
                            
                            if (daysChecked.length === 0) {
                                alert('Please select at least one day of the week');
                                return;
                            }
                            
                            repetitionConfig.repetition_config.interval = interval;
                            repetitionConfig.repetition_config.days_of_week = daysChecked;
                        } else if (repetitionType === 'monthly') {
                            const interval = parseInt(document.getElementById('monthlyInterval').value) || 1;
                            const dayOfMonth = parseInt(document.getElementById('monthlyDay').value) || 1;
                            
                            repetitionConfig.repetition_config.interval = interval;
                            repetitionConfig.repetition_config.day_of_month = dayOfMonth;
                        } else if (repetitionType === 'custom') {
                            const interval = parseInt(document.getElementById('customInterval').value) || 2;
                            const daysChecked = Array.from(document.querySelectorAll('#customDaysCheckboxes input[type=checkbox]:checked'))
                                .map(cb => parseInt(cb.value));
                            
                            if (daysChecked.length === 0) {
                                alert('Please select at least one day for custom repetition');
                                return;
                            }
                            
                            repetitionConfig.repetition_config.interval = interval;
                            repetitionConfig.repetition_config.days_of_week = daysChecked;
                        }
                        
                        properties[datePropId] = {
                            name: database.properties[datePropId].name,
                            type: 'date',
                            value: repetitionConfig
                        };
                    }
                }
                
                // Add description property
                if (descriptionElement) {
                    setTimeout(() => {
                        const descriptionContent = getRichTextContent('modalPageDescription');
                        if (descriptionContent && descriptionContent.trim()) {
                            properties['description'] = {
                                name: 'Description',
                                type: 'rich_text',
                                value: '',
                                rich_text_content: descriptionContent.trim()
                            };
                        }
                        
                        createPageWithProperties(databaseId, title, properties);
                    }, 100);
                } else {
                    createPageWithProperties(databaseId, title, properties);
                }
            }
        })
        .catch(error => {
            console.error('Error getting database data:', error);
        });
    
    closeModal();
}
</script>
{% endblock %}